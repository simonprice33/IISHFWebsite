@inherits UmbracoViewPage<ContentModels.ITC>
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Security
@using Umbraco.Cms.Core.Services
@using System.Globalization
@using IISHF.Core.Models
@inject IMemberManager MemberManager
@inject IMemberService MemberService
@{
    Layout = "Main.cshtml";
    var id = Model.Id;
    IPublishedContent? team = null;
    IPublishedContent? selectedTournament = null;
    var isSubmitted = false;

    var isLoggedIn = User.Identity.IsAuthenticated;
    MemberIdentityUser user = null;
    var isNmaApprover = false;
    var isIsshfApprover = false;

    if (!isLoggedIn)
    {
        // ToDo - Redirect to login pag as a fail safe
        // User should already be authenticated at this point.
    }

    Guid.TryParse(Context.Request.Query["team"].ToString(), out var teamInformationKey);
    if (teamInformationKey != Guid.Empty)
    {
        // build itc information from team information for event
        team = Umbraco.Content(teamInformationKey);
        selectedTournament = Umbraco.Content(team.Parent.Id);
        isSubmitted = team.Value<bool>("iTCSubmitted");
    }


    bool.TryParse(Context.Request.Query["create-new"], out var createNewItc);

    if (createNewItc)
    {
        isSubmitted = false;
    }

    var rosterMembers = team?.Children().Where(x => x.ContentType.Alias == "roster").ToList() ?? new List<IPublishedContent>();
    var players = rosterMembers.Where(x => !x.Value<bool>("isBenchOfficial")).ToList();
    var benchOfficials = rosterMembers.Where(x => x.Value<bool>("isBenchOfficial")).ToList();

    var heroImageObj = Model.Value<IPublishedContent>("heroImage");
    var heroImage = heroImageObj != null ? heroImageObj.Url() : "";

    var eventYear = DateTime.UtcNow.Year.ToString();

    var rootContent = Umbraco.ContentAtRoot().ToList();
    var tournaments = rootContent
        .FirstOrDefault(x => x.Name == "Home")!.Children()?
        .FirstOrDefault(x => x.Name == "Tournaments")!.Children().ToList();
    ;

    var cups = tournaments
        .FirstOrDefault(x => x.Name == "European Cups")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var championships = tournaments
        .FirstOrDefault(x => x.Name == "European Championships")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var nonTitle = tournaments
        .FirstOrDefault(x => x.Name == "None Title Events")
        .Children()
        .ToList();

    var allEvents = cups.Where(x => x != null).ToList()
        .Concat(championships.Where(x => x != null).ToList())
        .ToList().Select(x => new
        {
            EventName = x.Parent.Name, x.Id
        }).ToList();


    foreach (var nonTitleEvent in nonTitle)
    {
        allEvents.Add(new { EventName = nonTitleEvent.Name, nonTitleEvent.Id });
    }

    string[] priorityCountries = { "United Kingdom", "Germany", "Switzerland", "Austria", "Denmark", "Ukraine" };

    // Get all countries and ISO codes
    var countries = CultureInfo.GetCultures(CultureTypes.SpecificCultures)
        .Select(c => new RegionInfo(c.Name))
        .Distinct()
        .Select(x => new
        {
            Country = x.EnglishName,
            ISO3 = x.ThreeLetterISORegionName
        })
        .Where(x => !string.IsNullOrEmpty(x.ISO3))
        .OrderBy(x => Array.IndexOf(priorityCountries, x.Country) == -1 ? int.MaxValue : Array.IndexOf(priorityCountries.OrderBy(x => x).ToArray(), x.Country))
        .ThenBy(x => x.Country);

    // Retrieve user details
    user = await MemberManager.GetCurrentMemberAsync();
    Guid.TryParse(Context.Request.Query["approver"], out var approver);
    var member = MemberService.GetById(int.Parse(user.Id));

    if (approver != Guid.Empty && team != null)
    {
        isNmaApprover = member.GetValue<bool>("nMAITCApprover");

        isIsshfApprover = member.GetValue<bool>("iISHFITCApprover");

        var userMatchesKey = user.Key.Equals(approver);

        var nma = Umbraco.Content(team.Value<Guid>("nmaKey"));

        var approverIsWithNma = nma.Children()
            .Where(x => x.ContentType.Alias == "nMAContact")
            .Any(x => x.Value<string>("nMAContactEmail") == member.Email);

        if (!userMatchesKey && !approverIsWithNma)
        {
            isNmaApprover = false;
            // Redirect to an forbidden page
        }
    }

    if (team != null)
    {
        var nmaTeam = Umbraco.Content(team.Value<Guid>("nMATeamKey"));
        var userIsWithTeam = user.Email == nmaTeam.Value<string>("teamContactEmail"); // user is team contact
        var userIsClubContact = user.Email == null;
        if (!userIsWithTeam && !isNmaApprover && !isIsshfApprover)
        {
            players.Clear();
            benchOfficials.Clear();
            team = null;
            selectedTournament = null;
            isSubmitted = false;
        }
    }
}

<div class="jumbotron jumbotron-fluid hero hero-large" style="background-image: url('@heroImage')">
    <div class="overlay"></div>
    <div class="inner">
        <div class="container custom-container">
            <h1 class="display-4">@Model.Value("heroTitle")</h1>
            <p class="lead">@Model.Value("heroSubtitle")</p>
        </div>
    </div>
</div>

<div class="container custom-container mt-5 mb-5">
<div class="row">

<div class="col-md-3">
    <!-- Tabs nav -->
    <div class="nav flex-column nav-pills nav-pills-custom" id="v-pills-tab" role="tablist" aria-orientation="vertical">

        <span class="nav-link mb-3 p-3 shadow" id="v-pills-players-tab">
            <select id="eventSelect" class="form-control">
                @{
                                <option value="">Select Event for @DateTime.Now.Year.ToString()</option>

                    foreach (var iishfEvent in allEvents)
                    {
                                    <option value="@iishfEvent.Id">@iishfEvent.EventName</option>
                    }
                }
            </select>

            <div id="eventInformation"></div>
        </span>
        <a class="nav-link mb-3 p-3 shadow active" id="v-pills-team-tab" data-bs-toggle="pill" href="#v-pills-team" role="tab" aria-controls="v-players-team" aria-selected="true">
            <span class="font-weight-bold small text-uppercase">Team Information</span>
        </a>
        <a class="nav-link mb-3 p-3 shadow" id="v-pills-players-tab" data-bs-toggle="pill" href="#v-pills-players" role="tab" aria-controls="v-players-players" aria-selected="true">
            <span class="font-weight-bold small text-uppercase">Players</span>
            @{
                if (isNmaApprover || isIsshfApprover)
                {
                                <div id="counterId1">0 of X approved</div>
                }
            }
        </a>
        <a class="nav-link mb-3 p-3 shadow" id="v-pills-bench-tab" data-bs-toggle="pill" href="#v-pills-bench" role="tab" aria-controls="v-bench-bench" aria-selected="true">
            <span class="font-weight-bold small text-uppercase">Bench Officials</span>
            @{
                if (isNmaApprover || isIsshfApprover)
                {
                                <div id="counterId2">0 of X approved</div>
                }
            }
        </a>
        <a class="nav-link mb-3 p-3 shadow" id="v-pills-guest-tab" data-bs-toggle="pill" href="#v-pills-guest" role="tab" aria-controls="v-guest" aria-selected="true">
            <span class="font-weight-bold small text-uppercase">Guest Player Permission Letters</span>
        </a>

        <a class="nav-link mb-3 p-3 shadow" id="v-pills-submit-tab" data-bs-toggle="pill" href="#v-pills-submit" role="tab" aria-controls="v-submit-submit" aria-selected="true">
            <span class="font-weight-bold small text-uppercase">Validate and Submit</span>
        </a>
    </div>

</div>
<div class="col-md-9">
<!-- Tabs content -->
<div class="tab-content" id="v-pills-tabContent">
<div class="tab-pane fade shadow rounded bg-white show active p-5" id="v-pills-team" role="tabpanel" aria-labelledby="v-pills-team-tab">
    <div class="row form-group">
        <label for="teamName" class="col-12 col-md-4 col-form-label">Team Name:</label>
        <div class="col-12 col-md-8" style="position: relative;">
            @{
                var teamName = team?.Name ?? string.Empty;
            }
            <input type="text" class="form-control" placeholder="Team Name" id="teamName" value="@teamName"/>
            <div id="suggestionsContainer"></div>


        </div>
    </div>
    <div class="row form-group">
        <label for="teamSignatory" class="col-12 col-md-4 col-form-label">Team Signatory:</label>
        <div class="col-12 col-md-8">
            @{
                var teamSignatory = team?.Value<string>("teamSignatory") ?? string.Empty;
            }
            <input type="text" class="form-control" placeholder="Team Signatory" id="teamSignatory" value="@teamSignatory"/>
        </div>
    </div>
    <div class="row form-group">
        <label for="issuingCountry" class="col-12 col-md-4 col-form-label">Issuing Country:</label>
        <div class="col-12 col-md-8">
            <select class="form-control" id="issuingCountry" name="issuingCountry">
                <option value="">Nationality</option>
                @{
                    var addedSeparator = false; // Flag to check if separator has been added
                    // This will get the index of last priority country in the sorted list
                    var lastPriorityCountryIndex = countries.ToList().FindLastIndex(c => priorityCountries.Contains(c.Country));

                    foreach (var country in countries)
                    {
                        if (country.ISO3 == team?.Value<string>("countryIso3"))
                        {
                                        <option selected="true" value="@country.ISO3">@country.Country</option>
                        }
                        else
                        {
                                        <option value="@country.ISO3">@country.Country</option>
                        }
                        if (countries.ToList().IndexOf(country) == lastPriorityCountryIndex && !addedSeparator)
                        {
                            // Add the separator
                                        <option disabled>──────────</option>
                            addedSeparator = true; // Ensure the separator is only added once
                        }
                    }
                }

            </select>
        </div>
    </div>
    <div class="row form-group">
        <label for="colourOne" class="col-12 col-md-4 col-form-label">First Jersey Colour:</label>
        <div class="col-12 col-md-4">
            <div class="input-group mb-3">
                <div id="colorPicker" class="input-group-prepend color-picker-container"></div>
                <input type="text" class="form-control" placeholder="Team colour" id="colourOne" aria-label="Team colour in hex" aria-describedby="colorPickerAddon">
            </div>
        </div>
    </div>
    <div class="row form-group">
        <label for="jerseyTwoColour" class="col-12 col-sm-4 col-md-4 col-form-label">Second Jersey Colour:</label>
        <div class="col-12 col-md-4">
            <div class="input-group mb-3">
                <div id="colorPicker2" class="input-group-prepend color-picker-container"></div>
                <input type="text" class="form-control" placeholder="Team colour" id="colourTwo" aria-label="Team colour in hex" aria-describedby="colorPickerAddon">
            </div>
        </div>
    </div>
</div>

<div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-players" role="tabpanel" aria-labelledby="v-pills-players-tab">
    <div class="table-responsive">
        <table id="data-table" class="table table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
            <thead>
            <tr>
                <th style="width: 150px">License</th>
                <th>Role</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th class="text-center" style="width: 50px">Jersey Number</th>
                <th>Date of Birth</th>
                <th>Nationality</th>
                <th>Gender</th>

                @{
                    if (selectedTournament != null && !selectedTournament.Value<string>("sanctionNumber").StartsWith("A", StringComparison.CurrentCultureIgnoreCase))
                    {
                                    <th>Is Guest</th>
                    }
                }

                @* To Do -  remove submitted check as action wil always be here for writer and approver *@
                @{
                    if (!isSubmitted)
                    {
                                    <th></th>
                    }

                    if (isNmaApprover)
                    {
                                    <th>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkAllPlayers">
                                            <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                        </div>
                                    </th>
                    }
                    if (isIsshfApprover)
                    {
                                    <th class="text-center">

                                        NMA Check
                                    </th>
                                    <th>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="checkAllPlayers">
                                            <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                        </div>
                                    </th>
                    }
                }
            </tr>
            </thead>
            <tbody id="formRows">
            @for (var i = 0; i < players.Count(); i++)
            {
                <tr data-id="@players[i].Id">
                    <td>
                        <span>@players[i].Value("licenseNumber")</span>
                    </td>
                    <td>

                        <span>@players[i].Value("role")</span>
                    </td>
                    <td>

                        <span>@players[i].Value("firstName")</span>
                    </td>
                    <td>

                        <span>@players[i].Value("lastName")</span>
                    </td>
                    <td>
                        <span>@players[i].Value("jerseyNumber")</span>
                    </td>
                    <td>
                        @{
                            var dob = players[i].Value<DateTime>("dateOfBirth").ToString("dd.MM.yyyy");
                        }
                        <span>@dob</span>
                    </td>
                    <td>
                        <span>@players[i].Value("nationality")</span>
                    </td>
                    <td>

                        <span>@players[i].Value("gender")</span>
                    </td>
                    @{
                        if (!selectedTournament.Value<string>("sanctionNumber").StartsWith("A", StringComparison.CurrentCultureIgnoreCase))
                        {
                                        <td>
                                            @if (players[i].Value<bool>("isGuest"))
                                {
                                                <span>
                                                    <i class="fas fa-check"></i>
                                                </span>
                                }
                                        </td>
                        }
                    }
                    @{
                        if (!isSubmitted)
                        {
                                        <td>
                                            <button type="button" class="btn btn-danger" onclick="event.stopPropagation(); deleteRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                        }
                        if (isNmaApprover)
                        {
                            var checkId = $"player-id-{players[i].Id}";
                            var nmaCheckedState = players[i].Value<bool>("nmaCheck") ? "checked" : "";
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" @nmaCheckedState data-id="@players[i].Id" type="checkbox" id="@checkId">
                                                <label class="form-check-label" for="@checkId"></label>
                                            </div>

                                        </td>
                        }

                                    @if (isIsshfApprover)
                        {
                            var checkId = $"player-id-{players[i].Id}";
                            var iishfCheckedState = players[i].Value<bool>("iISHFCheck") ? "checked" : "";
                            var nmaCheckedState = players[i].Value<bool>("nmaCheck");
                                        <td class="text-center">
                                            @{
                                    if (nmaCheckedState)
                                    {
                                                                <span>
                                                                    <i class="fas fa-check"></i>
                                                                </span>
                                    }
                                            }
                                        </td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" @iishfCheckedState data-id="@players[i].Id" type="checkbox" id="@checkId">
                                                <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                            </div>

                                        </td>
                        }
                    }
                </tr>
            }
            </tbody>
        </table>
    </div>
    @{
        if (!isSubmitted)
        {
                        <button id="addRowButton" type="button">Add Row</button>
        }
    }

</div>

<div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-bench" role="tabpanel" aria-labelledby="v-pills-bench-tab">
    <table id="benchOfficials" class="table table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
        <thead>
        <tr>
            <th style="width: 150px">License</th>
            <th>Role</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Date of Birth</th>
            <th>Nationality</th>
            <th>Gender</th>
            @{
                if (!isSubmitted)
                {
                                <th></th>
                }


                if (isNmaApprover)
                {
                                <th>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="checkAllOfficials">
                                        <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                    </div>
                                </th>
                }
                if (isIsshfApprover)
                {
                                <th class="text-center">

                                    NMA Check
                                </th>
                                <th>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="checkAllOfficials">
                                        <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                    </div>
                                </th>
                }

            }
        </tr>
        </thead>
        <tbody id="formRowsBench">
        @for (var i = 0; i < benchOfficials.Count(); i++)
        {
            <tr data-id="@benchOfficials[i].Id">
                <td>
                    <span>@benchOfficials[i].Value("licenseNumber")</span>
                </td>
                <td>
                    <span>@benchOfficials[i].Value("role")</span>

                </td>
                <td>

                    <span>@benchOfficials[i].Value("firstName")</span>
                </td>
                <td>

                    <span>@benchOfficials[i].Value("lastName")</span>
                </td>
                <td>
                    @{
                        var dob = benchOfficials[i].Value<DateTime>("dateOfBirth").ToString("dd.MM.yyyy");
                    }
                    <span>@dob</span>
                </td>
                <td>
                    <span>@benchOfficials[i].Value("nationality")</span>
                </td>
                <td>
                    <span>@benchOfficials[i].Value("gender")</span>
                </td>
                @{
                    if (!isSubmitted)
                    {
                                    <td>
                                        <button type="button" class="btn btn-danger" onclick="event.stopPropagation(); deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                    }

                    if (isNmaApprover)
                    {
                        var checkId = $"player-id-{benchOfficials[i].Id}";
                        var nmaCheckedState = benchOfficials[i].Value<bool>("nmaCheck") ? "checked" : "";
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" @nmaCheckedState data-id="@benchOfficials[i].Id" type="checkbox" id="@checkId">
                                            <label class="form-check-label" for="@checkId"></label>
                                        </div>

                                    </td>
                    }

                                @if (isIsshfApprover)
                    {
                        var checkId = $"player-id-{benchOfficials[i].Id}";
                        var iishfCheckedState = benchOfficials[i].Value<bool>("iISHFCheck") ? "checked" : "";
                        var nmaCheckedState = benchOfficials[i].Value<bool>("nmaCheck");
                                    <td class="text-center">
                                        @{
                                if (nmaCheckedState)
                                {
                                                            <span>
                                                                <i class="fas fa-check"></i>
                                                            </span>
                                }
                                        }
                                    </td>
                                    <td>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" @iishfCheckedState data-id="@benchOfficials[i].Id" type="checkbox" id="@checkId">
                                            <label class="form-check-label" for="flexSwitchCheckDefault"></label>
                                        </div>

                                    </td>
                    }
                }
            </tr>
        }
        </tbody>
    </table>

    <div id="addBenchOfficialButtonErrors" class="alert alert-danger" role="alert">
        <h3>Cannot add more than 8 bench officials</h3>
    </div>

    @{
        if (!isSubmitted)
        {
                        <button id="addBenchOfficialButton" type="button">Add Row</button>
        }
    }

</div>
<div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-guest" role="tabpanel" aria-labelledby="v-pills-guest-tab">

    <div id="logo warning" class="alert alert-warning" role="alert">
        <h3 class="text-center">When supplying a permission letter, please provide license number in the text box that will show under the file preview. </h3>
    </div>

    <form action="/upload-multiple-files" class="dropzone mb-3" id="multipleFilesDropzone"></form>

    <div id="documents">
        @{
            if (team != null
                && selectedTournament != null
                && !selectedTournament.Value<string>("sanctionNumber").StartsWith("A", StringComparison.CurrentCultureIgnoreCase)
                && team.Children().Any(x => x.ContentType.Alias == "guestPlayerPermission"))
            {
                            @await Html.PartialAsync("Partials/ITC/GuestPlayerPermissionDocuments.cshtml", new PermissionLetters
                       {
                           Permissionletters = team.Children().Where(x => x.ContentType.Alias == "guestPlayerPermission").ToList(),
                           Players = players
                       })
                ;
            }
        }
    </div>

</div>
<div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-submit" role="tabpanel" aria-labelledby="v-pills-submit-tab">


    <div class="button-container">
        @{
            if (!isSubmitted)
            {
                            <button class="btn btn-light m-1" type="submit" onclick="validateForms()">Validate</button>
                            <button class="btn btn-custom-draft m-1" onclick="submit(true)">Save Draft</button>
                            <button class="btn btn-custom-save m-1" onclick="submit(false)">Submit</button>
            }

            if (isNmaApprover && !isNmaApprover)
            {
            }

            if (isNmaApprover)
            {
                            <button class="btn btn-danger m-1">Reject with reasons</button>
                            <button id="nmaApprove" class="btn btn-custom-save m-1" data-approver="nma">Approve and send to IISHF</button>
            }

            if (isIsshfApprover)
            {
                            <button id="rejectWithReasons"class="btn btn-danger m-1">Reject with reasons</button>
                            <button id="iishfApprove" class="btn btn-custom-save m-1" data-approver="nma">Approve ITC</button>
            }

            if (isNmaApprover || isIsshfApprover)
            {
                            <div class="col-12" id="reasons"></div>
            }
        }
        </>
       

    </div>
    <!-- Existing content -->
    <div id="submissionErrors" class="alert alert-danger mb-3" role="alert">

    </div>
</div>
</div>
</div>
</div>

@*Change name to first name and last name*@
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Data</h5>
                <button type="button" class="close close-edit" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- The form inside the modal -->
                <form id="edit-form">
                    <div class="form-group">
                        <label for="license">License:</label>
                        <input type="text" class="form-control" id="license" name="license">
                    </div>
                    <div class="form-group">
                        <label for="role">Role:</label>
                        <select class="form-control" id="role" name="role">
                            <option value="">Select Role</option>
                            <option value="Captain">Captain</option>
                            <option value="Assistant Captain">Assistant Captain</option>
                            <option value="Netminder">Netminder</option>
                            <!-- Add other role options here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="firstName">First Name:</label>
                        <input type="text" class="form-control" id="firstName" name="firstName">
                    </div>
                    <div class="form-group">
                        <label for="lastName">Last Name:</label>
                        <input type="text" class="form-control" id="lastName" name="lastName">
                    </div>
                    <div id="jerseyNumberFormGroup" class="form-group">
                        <label for="jerseyNumber">Jersey Number:</label>
                        <input type="text" class="form-control" id="jerseyNumber" name="jerseyNumber">
                    </div>
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth:</label>
                        <input type="text" class="form-control" id="dateOfBirth" name="dateOfBirth">
                    </div>
                    <div class="form-group">
                        <label for="nationality">Nationality:</label>
                        <select class="form-control" id="nationality" name="nationality">
                            <option value="">Nationality</option>
                            @foreach (var country in countries)
                            {
                                <option value="@country.Country">@country.Country</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <!-- Label and select for Gender -->
                        <select class="form-control" id="gender" name="gender">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <!-- Add other gender options here -->
                        </select>
                    </div>

                    <div class="form-group mt-2">
                        <label for="isGuest">Is Guest:</label>
                        <!-- Label and select for Gender -->
                        <input type="checkbox" id="isGuest"/>
                    </div>

                    <!-- Add more input fields as necessary -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-edit" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveChanges">Update table</button>
            </div>
        </div>
    </div>
</div>

<script>

    var countries = @Html.Raw(Json.Serialize(countries));
    $("#submissionErrors").hide();

    var deletedLicenseNumbers = [];
    var selectedRoles = [];
    var allErrors = [];
    var licenseNumbers = [];
    var benchOfficialLicenseNumbers = []
    var licenseNumbersEncountered = [];
    var jerseyNumbersEncountered = [];
    var currentMode = 'add';
    var currentRow = null;
    var currentMode = 'player'; // Default mode
    var pickerOneHexVal = "";
    var pickerTwoHexVal = "";

    function deleteRow(button) {
        // Find the row containing the clicked button
        var row = $(button).closest('tr');

        // Extract the license number from the span
        var licenseNumber = row.find("td:eq(0) span span").text().trim();

        // Add the license number to the array (if it's not empty)
        if (licenseNumber) {
            deletedLicenseNumbers.push(licenseNumber);
        }
        var titleEvent = $('#shortCode').val()
        var rosterId = row.data('id')
        var eventSelectValue = $("#eventSelect").val();
        var isChampionship = eventSelectValue.toLowerCase().includes("championship");

        var startDateText = $("#startDate").text();
        var eventYear = ''

        if (startDateText) {
            var parts = startDateText.split('.');

            if (parts.length >= 3) {
                eventYear = parts[2];
            } else {
                console.log("The date format is not as expected.");
            }
        } else {
            console.log("No text found for #startDate.");
        }

        var teamName = $("#teamName").val()

        var url = `/api/events/itc/team/tournament/${eventSelectValue}/team/${teamName}/roster-member/${rosterId}`
        var encodedUrl = encodeURI(url);
        $.ajax({
            url: encodedUrl,
            type: 'DELETE',
            success: function (data) {
                // Remove the row from the table
                row.remove();
            },
            error: function (xhr, status, error) {
                console.error("Error: " + error);
                // Show alert that something went wrong
            }
        });
    }

    function validateRow(licenseNumber, jerseyNumber, firstName, lastName, role, dateOfBirth, nationality, gender, rowIndex) {

        var errors = [];
        if (!licenseNumber || isNaN(parseInt(licenseNumber))) {
            errors.push('Invalid license number at row ' + (rowIndex + 1));
        }
        if (!jerseyNumber || isNaN(parseInt(jerseyNumber))) {
            errors.push('Invalid jersey number at row ' + (rowIndex + 1));
        }

        if (!firstName || firstName === "") {
            errors.push('Player name first is required');
        }
        if (!lastName || lastName === "") {
            errors.push('Player last name is required');
        }

        if (!dateOfBirth || dateOfBirth === "" || dateOfBirth === "01.01.0001") {
            errors.push('Date of birth is requried');
        }

        if (!nationality || nationality === "") {
            errors.push('Nationality is requried');
        }

        if (!role || role === "") {
            errors.push('Roster member role is requried');
        }

        if (!gender || gender === "") {
            errors.push('Roster member gender is requried');
        }
        var isFemale = gender !== "" && gender === "Female";
        var ageGroup = $("#ageGroup").text();
        if (dateOfBirth !== "01.01.0001" && !validateAge(dateOfBirth, ageGroup, isFemale)) {
            errors.push('Player is outside of the designated age range for this event');
        }

        return errors;
    }

    function validateBenchRow(licenseNumber, firstName, lastName, role, dateOfBirth, nationality, gender, rowIndex) {

        var errors = [];

        if (!firstName || firstName === "") {
            errors.push('Official name first is required');
        }

        if (!lastName || lastName === "") {
            errors.push('Official last name is required');
        }

        if (!dateOfBirth || dateOfBirth === "" || dateOfBirth === "01.01.0001") {
            errors.push('Date of birth is requried');
        }

        if (!nationality || nationality === "") {
            errors.push('Nationality is requried');
        }

        if (!role || role === "") {
            errors.push('Roster member role is requried');
        }

        if (!gender || gender === "") {
            errors.push('Roster member gender is requried');
        }

        return errors;
    }

    function validateForm() {
        var isValid = true;
        var licenseNumbers = [];
        var jerseyNumbers = [];
        var roles = [];
        var guests = []
        

        // Clear any previous error indicators
        $('#formRows tr').removeClass('table-danger');
        $('#submissionErrors').empty();
        
        // Collect all license and jersey numbers
        $('#formRows tr').each(function (index) {
            var currentRow = $(this);
            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var firstName = currentRow.find("td:eq(1) span span").text().trim();
            var lastName = currentRow.find("td:eq(2) span span").text().trim();
            var jerseyNumber = currentRow.find("td:eq(4) span span").text().trim();
            var role = currentRow.find("td:eq(1) span span").text().trim();
            var playerName = currentRow.find("td:eq(2) span span").text().trim() + ' ' + currentRow.find("td:eq(3) span span").text().trim();

            // Define the position for the new column based on zero-based index; 8th position for 9th column.
            var columnIndex = 8;

            // Check if the "Is Guest" column already exists
            var isGuestColumnExists = $('#data-table thead tr th').eq(columnIndex).text() === 'Is Guest';

            if (isGuestColumnExists) { 
                 var guest = currentRow.find("td:eq(8) i.fa-check").length > 0
                if (guest) { 
                    guests.push({firstName : firstName, lastname : lastName, isGuest : guest })
                }
            }
            // Add numbers to arrays for duplicate checking
            if (licenseNumber) {
                licenseNumbers.push({ number: licenseNumber, row: index + 1 });
            }
            if (jerseyNumber) {
                jerseyNumbers.push({ number: jerseyNumber, row: index + 1 });
            }
            if (role) {
                roles.push({ role: role, row: index + 1 });
            }
            

        });

        console.log("Guests : " + guests.length)

        var sanction = $("#sanction").text();
        var classification = sanction.charAt(0).toUpperCase(); // Get the first character and convert to uppercase
        var isTitleEvent = classification === "A";

        // Check for duplicates in license and jersey numbers
        var duplicateLicenseNumbers = findDuplicates(licenseNumbers);
        var duplicateJerseyNumbers = findDuplicates(jerseyNumbers);

        var roleArray = roles.map(item => item.role);

        var guestFiles = uploadFilesWithLabels();

        var netminderCount = roleArray.filter(x => x === "Netminder");
        var captainCount = roleArray.filter(x => x === "Captain");
        var assitantCaptainCount = roleArray.filter(x => x === "Assistant Captain");

        var teamName = $("#teamName").val()

        if (!isTitleEvent && guests.length > 1 && (!teamName.includes("select") || !teamName.includes("combination"))) {
            allErrors.push({
                name: "Guest player allowance exceeded",
                errors: "At International class B events, it is possible for a team to take one guest player. For more information, please refer to Regulation's 17.7 and 17.8"
            });
        }

        if (!isTitleEvent && guests.length > 1 && guestFiles.length != guests.length) {
            allErrors.push({
                name: "Guest player missing permission letters",
                errors: "All guest players and players on a select \ combination team need a signed letter of authority from their club \ team giving permission allowing them to play in a class B event. Please refer to Regulation's 17.7 and 17.8"
            });
        }

        var playerCount = $('#formRows tr').length;

        if (playerCount <= 7) { 
            allErrors.push({
                name: "Minimum roster count not met",
                errors: "For international matches the minimum number that shall be registered is 8 (7 outfield players and 1 goalkeeper). These players must be kitted up and be on the players bench or on the pitch for the first game. For more information please refer to Rules of the Game Rule 4.2.2"
            });
        }

        if (netminderCount.length < 1 && !isTitleEvent) {
            allErrors.push({
                name: "Minimum netminder count not met",
                errors: "For international matches the minimum number that shall be registered is 8 (7 outfield players and 1 goalkeeper). These players must be kitted up and be on the players bench or on the pitch for the first game. For more information please refer to Rules of the Game Rule 4.2.2"
            });
        }

        // create title event check here too
        if (netminderCount.length < 2 && isTitleEvent) {
            allErrors.push({
                name: "Minimum netminder count not met",
                errors: "For a IISHF Title Event each competing team must have a minimum of two netminders. Please refer to IISHF Regulations 18.18 "
            });
        }

        if (!captainCount || captainCount.length > 1) {
            allErrors.push({
                name: "Too many players are listed as Captain",
                errors: "A team can only have one named captain. You may change your captain per game at an event, however, your ITC may only have one listed person as captain"
            });
        }

        if (!assitantCaptainCount || assitantCaptainCount.length > 1) {
            allErrors.push({
                name: "Too many players are listed as Assitant Captain",
                errors: "A team can only have one named Assistant Captain. You may change your captain per game at an event, however, your ITC may only have one listed person as captain"
            });
        }

        if (!captainCount || captainCount.length === 0) {
            allErrors.push({
                name: "Missing Captain",
                errors: "A team must have one named captain"
            });
        }

        if (!assitantCaptainCount || assitantCaptainCount.length === 0) {
            allErrors.push({
                name: "Missing Assitant Captain",
                errors: "A team must have one named Assistant Captain."
            });
        }

        // Validate each row
        $('#formRows tr').each(function (index) {
            var currentRow = $(this);
            var rowErrors = [];

            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var role = currentRow.find("td:eq(1) span span").text().trim();
            var firstName = currentRow.find("td:eq(2) span span").text().trim();
            var lastName = currentRow.find("td:eq(3) span span").text().trim();
            var jerseyNumber = currentRow.find("td:eq(4) span span").text().trim();
            var dateOfBirth = currentRow.find("td:eq(5) span span").text().trim();
            var nationality = currentRow.find("td:eq(6) span span").text().trim();
            var gender = currentRow.find("td:eq(7) span span").text().trim();

            var rowErrors = validateRow(licenseNumber, jerseyNumber, firstName, lastName, role, dateOfBirth, nationality, gender, index);

            // Check if license or jersey number is in duplicate arrays
            if (duplicateLicenseNumbers.has(licenseNumber)) {
                rowErrors.push('Duplicate license number: ' + licenseNumber);
            }
            if (duplicateJerseyNumbers.has(jerseyNumber)) {
                rowErrors.push('Duplicate jersey number: ' + jerseyNumber);
            }

            // Highlight the row if there are errors
            if (rowErrors.length > 0) {
                isValid = false;
                currentRow.addClass('table-danger');
                allErrors.push({
                    name: firstName + ' ' + lastName,
                    errors: rowErrors
                });
            }

            console.log(allErrors)
        });


        return isValid;
    }

    function uploadFilesWithLabels() {
        var myDropzone = Dropzone.forElement("#multipleFilesDropzone");
        var files = myDropzone.getAcceptedFiles();
        var filesAndLabels = [];
    
        files.forEach(function(file) {
            var label = $(file.previewElement).find("input[name='fileLabel']").val();
            filesAndLabels.push({file: file, label: label});
        });
    
        // sendFilesAndLabelsAjax(filesAndLabels);

        return filesAndLabels;
    }

    function validateAge(dateOfBirth, ageGroup, isFemale) {
        // Parse the date of birth to a Date object
        var parts = dateOfBirth.split('.');
        if (parts.length !== 3) {
            return false; // Invalid date format
        }

        var day = parseInt(parts[0], 10);
        var month = parseInt(parts[1], 10) - 1; // Month is zero-based
        var year = parseInt(parts[2], 10);

        var dobDate = new Date(year, month, day);

        // Check if the date is a valid date
        if (isNaN(dobDate.getTime())) {
            return false; // Invalid date
        }

        // Calculate the age based on the date of birth
        var currentYear = new Date().getFullYear();
        var birthYear = dobDate.getFullYear();
        var age = currentYear - birthYear;

        // Define age validation rules based on age group and gender
        // Female check first
        // Male check second
        // Female players can be one year older in teh age group.

        var sanction = $("#sanction").text()
        var classification = sanction.substring(1)
        var isTitleEvent = classification === "A" || classification === "a";

        var eventSelectValue = $("#eventSelect").val();
        var isChampionshipEvent = eventSelectValue.toLowerCase().includes("championship");

        // Define the additional age adjustment based on gender and age group for title events
        var additionalAgeAdjustment = 0; // Default value

        if (isTitleEvent && !isChampionshipEvent) {
            if (!isFemale) {
                // Male players can be one year older in U19, U16, U13, and U10 age groups
                if (ageGroup === 'U19' || ageGroup === 'U16' || ageGroup === 'U13' || ageGroup === 'U10') {
                    additionalAgeAdjustment = 1;
                }
            } else {
                // Female players can be two years older in U19, U16, U13, and U10 age groups
                if (ageGroup === 'U19' || ageGroup === 'U16' || ageGroup === 'U13' || ageGroup === 'U10') {
                    additionalAgeAdjustment = 2;
                }
            }
        }

        // Adjust the age based on the additional age adjustment
        age += additionalAgeAdjustment;

        switch (ageGroup) {
            case 'U19':
                if ((isFemale && age >= 13 && age <= 19) || (!isFemale && age >= 13 && age <= 18)) {
                    return true; // Valid age
                }
                break;
            case 'U16':
                if ((isFemale && age >= 10 && age <= 16) || (!isFemale && age >= 10 && age <= 15)) {
                    return true; // Valid age
                }
                break;
            case 'U13':
                if ((isFemale && age >= 10 && age <= 13) || (!isFemale && age >= 10 && age <= 12)) {
                    return true; // Valid age
                }
                break;
            case 'U10':
                if (age <= 9) {
                    return true; // Valid age
                }
                break;
            case 'Senior':
                if (age >= 19) {
                    return true; // Valid age
                }
                break;
            case 'Senior Women':
                if (age >= 16) {
                    return true; // Valid age
                }
                break;
            case 'Masters':
                if (age >= 45) {
                    return true; // Valid age
                }
                break;
            case 'Women':
                if (age >= 35) {
                    return true; // Valid age
                }
                break;
            default:
                return false; // Invalid age group
        }

        return false; // Age does not meet the specified age group rules
    }

    function validateBenchForm() {
        var isValid = true;
        var licenseNumbers = [];
        var jerseyNumbers = [];

        var benchOfficialCount = $('#formRowsBench tr').length;
        console.log("Number of bench officials: " + benchOfficialCount)

        var sanction = $("#sanction").text();
        var classification = sanction.charAt(0).toUpperCase(); // Get the first character and convert to uppercase
        var isTitleEvent = classification === "A";

        if (isTitleEvent && benchOfficialCount === 0) {
            allErrors.push({
                name: 'Bench Officials',
                errors: 'ITC needs at least one bench official.'
            })
        }

        // Clear any previous error indicators
        $('#formRowsBench tr').removeClass('table-danger');
        $('#submissionErrors').empty();
        $('#submissionErrors').hide();
        // Collect all license and jersey numbers
        $('#formRowsBench tr').each(function (index) {
            var currentRow = $(this);
            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var jerseyNumber = currentRow.find("td:eq(3) span span").text().trim();

            // Add numbers to arrays for duplicate checking
            if (licenseNumber) {
                licenseNumbers.push({ number: licenseNumber, row: index + 1 });
            }
            if (jerseyNumber) {
                jerseyNumbers.push({ number: jerseyNumber, row: index + 1 });
            }
        });

        // Check for duplicates in license and jersey numbers
        var duplicateLicenseNumbers = findDuplicates(licenseNumbers);
        var duplicateJerseyNumbers = findDuplicates(jerseyNumbers);

        // Validate each row
        $('#formRowsBench tr').each(function (index) {
            var currentRow = $(this);
            var rowErrors = [];

            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var role = currentRow.find("td:eq(1) span span").text().trim();
            var firstName = currentRow.find("td:eq(2) span span").text().trim();
            var lastName = currentRow.find("td:eq(3) span span").text().trim();
            var dateOfBirth = currentRow.find("td:eq(4) span span").text().trim();
            var nationality = currentRow.find("td:eq(5) span span").text().trim();
            var gender = currentRow.find("td:eq(6) span span").text().trim();

            var rowErrors = validateBenchRow(licenseNumber, firstName, lastName, role, dateOfBirth, nationality, gender, index);

            // Check if license or jersey number is in duplicate arrays
            if (duplicateLicenseNumbers.has(licenseNumber)) {
                rowErrors.push('Duplicate license number: ' + licenseNumber);
            }

            // Highlight the row if there are errors
            if (rowErrors.length > 0) {
                isValid = false;
                currentRow.addClass('table-danger');
                allErrors.push({
                    name: firstName + ' ' + lastName,
                    errors: rowErrors
                });
            }

            console.log(allErrors)
        });

        return isValid;
    }

    function findDuplicates(numbers) {
        var duplicates = new Set();
        var seen = new Map();

        numbers.forEach(item => {
            if (seen.has(item.number)) {
                duplicates.add(item.number);
            } else {
                seen.set(item.number, item.row);
            }
        });

        return duplicates;
    }

    function displayValidationErrors(errors) {
        var errorContainer = $('#submissionErrors');
        $('#submissionErrors').hide();

        errorContainer.empty();
        if (errors) {
            var errorList = $('<ul></ul>');

            if (Array.isArray(errors)) {
                // Handle errors as an array of objects
                for (var i = 0; i < errors.length; i++) {
                    if (errors[i]) {
                        if (Array.isArray(errors[i].errors)) {

                            var errorText = ""
                            if (errors[i].name === "") {
                                errors[i].errors.join(', ');

                            } else {
                                errorText = errors[i].name + ': ' + errors[i].errors.join(', ');
                            }

                            errorList.append($('<li class="mb-2"></li>').text(errorText));
                        } else if (typeof errors[i].errors === 'string') {
                            errorList.append($('<li class="mb-2"></li>').text(errors[i].name + ': ' + errors[i].errors));
                        }
                    }
                }
            } else if (typeof errors === 'string') {
                // Handle errors as a single string
                errorList.append($('<li class="mb-2"></li>').text(errors));
            }

            errorContainer.append(errorList);
            if (errors.length > 0) {
             $("#submissionErrors").removeClass('alert-success')   
                 $("#submissionErrors").addClass('alert-danger')   
                errorContainer.show();
            } 
            

        } else {
            errorContainer.hide();
        }
    }

    function validateForms() {
        $('#submissionErrors').hide();

        allErrors = [];
        licenseNumbers = [];
        benchOfficialLicenseNumbers = []
        playersAndOfficials = []

        var teamName = $('#teamName').val(); // Gets the value from the Team Name input field
        var teamSignatory = $('#teamSignatory').val(); // Gets the value from the Team Signatory input field
        var issuingCountry = $('#issuingCountry').val(); // Gets the selected value from the Issuing Country dropdown

        if (teamName === "") {
            allErrors.push({
                name: "Team name not supplied",
                errors: 'A team name must be provided'
            });
        }

        if (teamSignatory === "") {
            allErrors.push({
                name: "Team signatory name not supplied",
                errors: 'A team signatory must be provided.'
            });
        }

        if (teamSignatory === teamName) {
            allErrors.push({
                name: "Team signatory cannot be a team name",
                errors: 'Team signatory is the named person responsible for the team whilst at the event. Team signatory should also be the same person submitting the ITC.'
            });
        }

        if (issuingCountry === "") {
            allErrors.push({
                name: "Issuing Country not supplied",
                errors: 'Please provide the issuing country details. This is the country of the team that this document is being issued on behalf of. '
            });
        }

        validateForm();
        validateBenchForm()
        checkDuplicatePlayerNameAndLicenseNumber()
        displayValidationErrors(allErrors);

        if (allErrors.length > 0) {
            return false
        }
        if (allErrors.length === 0) {

             $("#submissionErrors").removeClass('alert-danger')   
             $("#submissionErrors").addClass('alert-success')   
             $('#submissionErrors').append("<h2 class='text-center'>ITC is valid and can be submitted</h2>")
             $('#submissionErrors').show();
             setTimeout(function () { $('#submissionErrors').slideUp();}, 20000)
        }
        return true
    }

    function submit(isDraft) {

        if (!isDraft && !validateForms()) {
            return
        }

        var json = generateJson(isDraft);
        console.log(JSON.stringify(json));

        $.ajax({
            type: "PUT",
            url: "/api/events/itc",
            data: JSON.stringify(json),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
                console.log("Sending results to update row ids");
                updateRowIds(result);

                // ToDo titleEventCheck
                // only needed if not title event
                UploadFiles(result.TeamId)

                if (!isDraft) { 
                window.location = '/my-account'
                }
            },
            error: function (result) {
                console.log(result);
            }
        });
    }

    function UploadFiles(teamId) {
    
        var tournamentId = $("#eventSelect").val();
        // Create a FormData object
            var formData = new FormData();

             var dropzone = Dropzone.forElement("#multipleFilesDropzone");
       var files = dropzone.getAcceptedFiles();
       var formData = new FormData(); // Make sure you have initialized FormData.
       
       files.forEach(function(file, index) {
           // First, get the label for the current file
           var label = $(file.previewElement).find("input[name='fileLabel']").val();
       
           // Now use the label when appending the file to formData
           formData.append('files[' + index + ']', file);
           formData.append('labels[' + label + ']', label);
       });

    // Perform the AJAX request
    $.ajax({
        url: `/api/events/itc/guest-permission-letters/tournament/${tournamentId}/team/${teamId}`, // Replace with your actual endpoint
        type: 'POST',
        data: formData,
        processData: false, // Important: Don't process files
        contentType: false, // Important: Don't set contentType
        success: function(response) {
            console.log('Success:', response);
            // Optionally, clear the Dropzone for the next batch of files
            dropzone.removeAllFiles(true);

            $.get('/umbraco/surface/events/GetPermissionDocuments', { tournamentId: tournamentId, teamId: teamId }, function (data) {
                     $('#documents').html(data);
                });

        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
    
    }

    function updateRowIds(updatedRoster) {
            console.log("updating row ids")
            updatedRoster.ItcRosterMembers.forEach(function (member) {
                if (member.id !== 0) {
                    console.log(member)
                    // Construct the jQuery selector to find the row with matching license number and last name
                    $("#data-table tbody tr").each(function () {
                        var firstName = $(this).find('td:nth-child(3) span span').text().trim();
                        var lastName = $(this).find('td:nth-child(4) span span').text().trim();
                        if (firstName === member.firstName && lastName === member.lastName) {
                            $(this).attr('data-id', member.id);
                        }
                    });

                    $("#benchOfficials tbody tr").each(function () {
                        var firstName = $(this).find('td:nth-child(3) span span').text().trim();
                        var lastName = $(this).find('td:nth-child(4) span span').text().trim();
                        if (firstName === member.firstName && lastName === member.lastName) {
                            $(this).attr('data-id', member.id);
                        }
                    });
                }
            });
        }

    function generateJson(isDraft) {

        // Retrieve the value of the element with ID 'startDate'
        var startDate = $("#startDate").text();
        var year = "";
        // Check if startDate is not undefined or null
        if (startDate) {
            // Split the value by the dot
            var parts = startDate.split('.');

            // Check if the array has at least three parts (to avoid errors)
            if (parts.length >= 3) {
                year = parts[2]; // This will be the third part of the split string
            } else {
                console.log("The date format is not as expected.");
            }
        } else {
            console.log("No value found for #startDate.");
        }

        var formData = {
            "EventId": $("#eventSelect").val(),
            "EventYear": year, 
            "TitleEvent": $('#shortCode').val(), 
            "isChampionship": document.getElementById('isChampionship').checked, 
            "ItcRosterMembers": [],
            "TeamName": $('#teamName').val(), 
            "JerseyOne": $('#colourOne').val(),
            "JerseyTwo": $('#colourTwo').val(),
            "SubmitToHost": !isDraft,
            "TeamSignatory" : $("#teamSignatory").val(),
            "IssuingCountry" : $("#issuingCountry").val(),
            "nmaTeamId": $("#teamName").attr('data-id'),
            "nmaTeamKey": $("#teamName").attr('data-key'),
        };

        var processRow = function (currentRow, isBench) {

            var $currentRow = $(currentRow); // Convert to jQuery object
            var rosterId = $currentRow.attr('data-id');
            var license = currentRow.querySelector("td:nth-child(1) span span").textContent.trim();
            var role = currentRow.querySelector("td:nth-child(2) span span").textContent.trim();
            var firstName = currentRow.querySelector("td:nth-child(3) span span").textContent.trim();
            var lastName = currentRow.querySelector("td:nth-child(4) span span").textContent.trim();
            var dateOfBirth = null;
            var isGuest = false
            if (isBench) {
                dateOfBirth = currentRow.querySelector("td:nth-child(5) span span").textContent.trim();
                var nationality = currentRow.querySelector("td:nth-child(6) span span").textContent.trim();
                var gender = currentRow.querySelector("td:nth-child(7) span span").textContent.trim();
            } else {

                var jerseyNumber = parseInt(currentRow.querySelector("td:nth-child(5) span span").textContent.trim(), 10);
                dateOfBirth = currentRow.querySelector("td:nth-child(6) span span").textContent.trim();
                var nationality = currentRow.querySelector("td:nth-child(7) span span").textContent.trim();
                var gender = currentRow.querySelector("td:nth-child(8) span span").textContent.trim();
                 var isGuestColumnExists = $('#data-table thead tr th').eq(8).text() === 'Is Guest';
                if (isGuestColumnExists) { 
                    isGuest = $currentRow.find("td:nth-child(9) span span i").hasClass('fa-check');
                }
                
            }

            if (dateOfBirth === "01.01.0001" || dateOfBirth === "01.01.1753") {
                dateOfBirth = null;
            }

            // Split the date into [day, month, year]
            var parts = dateOfBirth.split(".");

            // Rearrange the parts into yyyy-mm-dd format
            // Note: parts index starts from 0, so parts[0] is day, parts[1] is month, parts[2] is year
            var formattedDate = parts[2] + "-" + parts[1] + "-" + parts[0];

            formData.ItcRosterMembers.push({
                "Id": rosterId,
                "License": license,
                "firstName": firstName,
                "lastName": lastName,
                "JerseyNumber": jerseyNumber,
                "Role": role,
                "IsBenchOfficial": isBench,
                "DateOfBirth": formattedDate,
                "Nationality": nationality,
                "Gender": gender,
                "isGuest" : isGuest,
            });
        };

        document.querySelectorAll('#formRows tr').forEach(function (row) {
            processRow(row, false);
        });

        document.querySelectorAll('#formRowsBench tr').forEach(function (row) {
            
            processRow(row, true);
        });

        return formData;
    }

    function clearModalFields() {
        $('#edit-form').find('input[type="text"], select').val('');
    }

    function populateModalFromRow(currentRow) {

        var sanctionNumber = $('#sanction')[0].innerHTML;

        if (sanctionNumber && sanctionNumber.charAt(0) !== 'A') {
            var isGuestChecked = currentRow.find("td:eq(8) i.fa-check").length > 0;
            $('#isGuest').prop('checked', isGuestChecked);
        }

        var license = currentRow.find("td:eq(0) .tablesaw-cell-content span").text().trim();
        var role = currentRow.find("td:eq(1) .tablesaw-cell-content span").text().trim();
        var firstName = currentRow.find("td:eq(2) .tablesaw-cell-content span").text().trim();
        var lastName = currentRow.find("td:eq(3) .tablesaw-cell-content span").text().trim();
        var jerseyNumber = currentRow.find("td:eq(4) .tablesaw-cell-content span").text().trim();
        var dateOfBirth = currentRow.find("td:eq(5) .tablesaw-cell-content span").text().trim();
        var nationality = currentRow.find("td:eq(6) .tablesaw-cell-content span").text().trim();
        var gender = currentRow.find("td:eq(7) .tablesaw-cell-content span").text().trim();

        $('#edit-form #license').val(license);
        $('#edit-form #role').val(role);
        $('#edit-form #firstName').val(firstName);
        $('#edit-form #lastName').val(lastName);
        $('#edit-form #jerseyNumber').val(jerseyNumber);
        $('#edit-form #dateOfBirth').val(dateOfBirth);
        $('#edit-form #nationality').val(nationality);
        $('#edit-form #gender').val(gender);
    }

    function updateRowFromModal(row) {
        row.find("td:eq(0) .tablesaw-cell-content span").text($('#edit-form #license').val());
        row.find("td:eq(1) .tablesaw-cell-content span").text($('#edit-form #role').val());
        row.find("td:eq(2) .tablesaw-cell-content span").text($('#edit-form #firstName').val());
        row.find("td:eq(3) .tablesaw-cell-content span").text($('#edit-form #lastName').val());
        row.find("td:eq(4) .tablesaw-cell-content span").text($('#edit-form #jerseyNumber').val());
        row.find("td:eq(5) .tablesaw-cell-content span").text($('#edit-form #dateOfBirth').val());
        row.find("td:eq(6) .tablesaw-cell-content span").text($('#edit-form #nationality').val());
        row.find("td:eq(7) .tablesaw-cell-content span").text($('#edit-form #gender').val());

        var sanctionNumber = $('#sanction')[0].innerHTML;

        if (sanctionNumber && sanctionNumber.charAt(0) !== 'A') {
            console.log("should update row")
            // Add the "Is Guest" column header at ordinal 9 (after 8th column)
            var isGuestChecked = $('#isGuest').is(':checked');
            var isGuestIconHtml = '<span><span><i class="fas fa-check"></i></span></span>'
            var isGuestIcon = isGuestChecked ? isGuestIconHtml : '';
            row.find("td:eq(8) .tablesaw-cell-content").html(isGuestIcon);
        }

        
    }

    function updateBenchOfficialRowFromModal(row) {
        row.find("td:eq(0) .tablesaw-cell-content span").text($('#edit-form #license').val());
        row.find("td:eq(1) .tablesaw-cell-content span").text($('#edit-form #role').val());
        row.find("td:eq(2) .tablesaw-cell-content span").text($('#edit-form #firstName').val());
        row.find("td:eq(3) .tablesaw-cell-content span").text($('#edit-form #lastName').val());
        row.find("td:eq(4) .tablesaw-cell-content span").text($('#edit-form #dateOfBirth').val());
        row.find("td:eq(5) .tablesaw-cell-content span").text($('#edit-form #nationality').val());
        row.find("td:eq(6) .tablesaw-cell-content span").text($('#edit-form #gender').val());
    }

    function populateModalForBenchOfficial(currentRow) {
        var license = currentRow.find("td:eq(0) .tablesaw-cell-content span").text().trim();
        var role = currentRow.find("td:eq(1) .tablesaw-cell-content span").text().trim();
        var firstName = currentRow.find("td:eq(2) .tablesaw-cell-content span").text().trim();
        var lastName = currentRow.find("td:eq(3) .tablesaw-cell-content span").text().trim();
        var dateOfBirth = currentRow.find("td:eq(4) .tablesaw-cell-content span").text().trim();
        var nationality = currentRow.find("td:eq(5) .tablesaw-cell-content span").text().trim();
        var gender = currentRow.find("td:eq(6) .tablesaw-cell-content span").text().trim();

        $('#edit-form #license').val(license);
        $('#edit-form #role').val(role);
        $('#edit-form #firstName').val(firstName);
        $('#edit-form #lastName').val(lastName);
        $('#edit-form #dateOfBirth').val(dateOfBirth);
        $('#edit-form #nationality').val(nationality);
        $('#edit-form #gender').val(gender);

        // Hide the jersey number field for bench officials
        $('#edit-form #jerseyNumber').closest('.form-group').hide();
    }

    function addNewRowFromModal() {

        var sanctionNumber = $('#sanction')[0].innerHTML;

        var guestCell = ''

        if (sanctionNumber && sanctionNumber.charAt(0) !== 'A') {
            // Add the "Is Guest" column header at ordinal 9 (after 8th column)
            var isGuestChecked = $('#isGuest').is(':checked');
            var isGuestIcon = isGuestChecked ? '<i class="fas fa-check"></i>' : '';
            guestCell = '<td class="text-center"><b class="tablesaw-cell-label">Is Guest</b><span class="tablesaw-cell-content"><span>' + isGuestIcon + '</span></span></td>'
        }

        var newRowHtml = '<tr data-id="0">' +
            '<td><b class="tablesaw-cell-label">License</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #license').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Role</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #role').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">First Name</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #firstName').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Last Name</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #lastName').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Jersey Number</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #jerseyNumber').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Date of Birth</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #dateOfBirth').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Nationality</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #nationality').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Gender</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #gender').val() + '</span></span></td>' +
            guestCell + 
            '<td><button type="button" class="btn btn-danger delete-btn" onclick="event.stopPropagation(); deleteRow(this);"><i class="fas fa-trash"></i></button></td>' +
            '</tr>';
        $('#data-table tbody').append(newRowHtml);
    }

    function addBenchOfficialRowFromModal() {
        var newRowHtml = '<tr data-id="0">' +
            '<td><b class="tablesaw-cell-label">License</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #license').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Role</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #role').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">First Name</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #firstName').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Last Name</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #lastName').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Date of Birth</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #dateOfBirth').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Nationality</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #nationality').val() + '</span></span></td>' +
            '<td><b class="tablesaw-cell-label">Gender</b><span class="tablesaw-cell-content"><span>' + $('#edit-form #gender').val() + '</span></span></td>' +
            '<td><button type="button" class="btn btn-danger delete-btn" onclick="event.stopPropagation(); deleteRow(this);"><i class="fas fa-trash"></i></button></td>' +
            '</tr>';
        $('#benchOfficials tbody').append(newRowHtml);
    }

    function checkDuplicateLicenseNumbers() {
        var licenseNumberMap = {}; // Object to store encountered license numbers and associated player names

        // Helper function to add player name to the license number entry
        function addPlayerName(licenseNumber, playerName) {
            if (licenseNumberMap[licenseNumber]) {
                licenseNumberMap[licenseNumber].push(playerName);
            } else {
                licenseNumberMap[licenseNumber] = [playerName];
            }
        }

        // Iterate through rows in the data table
        $('#data-table tbody tr').each(function () {
            var licenseNumber = $(this).find("td:eq(0) span span").text().trim();
            var playerName = $(this).find("td:eq(2) span span").text().trim();

            if (licenseNumber) {
                addPlayerName(licenseNumber, playerName);
            }
        });

        // Iterate through rows in the bench officials table
        $('#benchOfficials tbody tr').each(function () {
            var licenseNumber = $(this).find("td:eq(0) span span").text().trim();
            var playerName = $(this).find("td:eq(2) span span").text().trim();

            if (licenseNumber) {
                addPlayerName(licenseNumber, playerName);
            }
        });

        // Now, licenseNumberMap contains license numbers as keys and player names as values
        // You can check for duplicate license numbers and associated player names here
        for (var licenseNumber in licenseNumberMap) {
            if (licenseNumberMap[licenseNumber].length > 1) {
                allErrors.push({
                    name: licenseNumberMap[licenseNumber].join(', '),
                    errors: 'ITC listed Names with duplicate License Number in both Player and Bench Official tables with license number: ' + licenseNumber + '. Please refer to IISHF Regulations 20.13'
                });

            }
        }
    }

    function checkDuplicatePlayerNameAndLicenseNumber() {
        var playerNameAndLicense = new Set();

        // Iterate through rows in the data table
        $('#data-table tbody tr').each(function () {
            $(this).removeClass('table-danger');
            var playerName = $(this).find("td:eq(2) span span").text().trim() + ' ' + $(this).find("td:eq(3) span span").text().trim();
            var licenseNumber = $(this).find("td:eq(0) span span").text().trim();
            var combined = playerName + licenseNumber;

            if (playerName && licenseNumber) {
                if (playerNameAndLicense.has(combined)) {
                    $(this).addClass('table-danger');

                    allErrors.push({
                        name: playerName,
                        errors: 'A roster member cannot be listed as both a player and a bench official: ' + playerName + ' (' + licenseNumber + ')'
                    });
                } else {
                    playerNameAndLicense.add(combined);
                }
            }
        });

        // Iterate through rows in the bench officials table
        $('#benchOfficials tbody tr').each(function () {
            $(this).removeClass('table-danger');

            var playerName = $(this).find("td:eq(2) span span").text().trim() + ' ' + $(this).find("td:eq(3) span span").text().trim();
            var licenseNumber = $(this).find("td:eq(0) span span").text().trim();
            var combined = playerName + licenseNumber;

            if (playerName && licenseNumber) {
                if (playerNameAndLicense.has(combined)) {
                    $(this).addClass('table-danger');
                    allErrors.push({
                        name: playerName,
                        errors: 'A roster member cannot be listed as both a player and a bench official: ' + playerName + ' (' + licenseNumber + ')'
                    });
                } else {
                    playerNameAndLicense.add(combined);
                }
            }
        });
    }

    Dropzone.autoDiscover = false; // Prevent auto initialization

    $(document).ready(function () {

       var currentRow = null;
        // Function to update the counter text
    function updateCounter(tableId, counterId) {
        var checkedCount = $(tableId + ' .form-check-input:checked').not('#checkAllPlayers, #checkAllOfficials').length;
        var totalCount = $(tableId + ' .form-check-input').not('#checkAllPlayers, #checkAllOfficials').length;
        $(counterId).text(checkedCount + ' of ' + totalCount + ' approved');

        var checkboxClass = "form-check-input";

      $(tableId + ' .' + checkboxClass).change(function() {
    var memberId = $(this).data('id'); // Get the member ID from the data-id attribute
    var divId = 'rejected-player-' + memberId; // Construct the div ID
    var $div = $('#' + divId); // Get the div by ID

    // Check if the div exists
    if ($div.length > 0) {
        // If the checkbox is checked, hide the div; otherwise, show the div
        if ($(this).is(':checked')) {
            $div.hide(); // Hide the div if the checkbox is checked
        } else {
            $div.show(); // Show the div if the checkbox is unchecked
        }
    }

    // Calculate the total number of checkboxes and how many are checked
    var totalCount = $(tableId + ' .' + checkboxClass).length;
    var checkedCount = $(tableId + ' .' + checkboxClass + ':checked').length;

    // Check or uncheck the master checkbox based on whether all individual checkboxes are checked
    var allChecked = totalCount === checkedCount;
    $('#masterCheck').prop('checked', allChecked); // Make sure '#masterCheck' matches your master checkbox ID
});
    }

    // Function to toggle checkboxes in a specified table
    function toggleCheckboxes(masterCheckboxId, tableId, counterId) {
        // Event handler for the master checkbox
        $(masterCheckboxId).change(function() {
            $(tableId + ' .form-check-input').not(masterCheckboxId).prop('checked', this.checked).trigger('change');
        });

        // Event handler for individual checkboxes
        $(tableId + ' .form-check-input').not(masterCheckboxId).change(function() {
            // Update the master checkbox state
            var allChecked = $(tableId + ' .form-check-input').not(masterCheckboxId).length === $(tableId + ' .form-check-input:checked').not(masterCheckboxId).length;
            $(masterCheckboxId).prop('checked', allChecked);
            // Update the counter
            updateCounter(tableId, counterId);
        });

        // Initialize the counter on page load
        updateCounter(tableId, counterId);
    }

    // Apply the function to the first table and counter
    toggleCheckboxes('#checkAllPlayers', '#data-table', '#counterId1');
    // Apply the function to the second table and counter
    toggleCheckboxes('#checkAllOfficials', '#benchOfficials', '#counterId2');

       // Check the checkbox's state on page load
    updateCheckboxAppearance();

    $('#rejectWithReasons').on('click', function () { 

        $('#submissionErrors').hide();
        $('#submissionErrors').empty()

        var notCheckedPlayerIds = [];

        $('.form-check-input[data-id]').each(function() {
            if (!$(this).is(':checked')) {
                var playerId = $(this).data('id');
                notCheckedPlayerIds.push(playerId);
            }
        });

        if (notCheckedPlayerIds.length > 0) {
            // Serialize the array into a query string format that ASP.NET can bind to an array
            var queryString = $.param({ 'playerIds': notCheckedPlayerIds }, true);

            // Send the AJAX request
            GetRejectionReasons(queryString)
        } else {
            console.log("All players have been checked.");
        }

    })

        function GetRejectionReasons(queryString) {

            // Send the AJAX request
            $.ajax({
                url: '/umbraco/surface/events/GetRejectReasons?' + queryString, // Note: Query string is appended to the URL
                type: 'GET',
                success: function(response) {
                $("#reasons").hide()

                    // Handle the successful response here
                    $("#reasons").html(response);
                     $("#reasons").slideDown()
                },
                error: function(xhr) {
                    // Handle error here
                    console.error("Error: " + xhr.statusText);
                }
            });
        }

   $('#nmaApprove,  #iishfApprove').on('click', function() {
           $('#submissionErrors').hide();
            $('#submissionErrors').empty()

       var id = this.id; 
       var identifier = id.split('Approve')[0]; 
        var approvedRosterMembers = []; // Initialize an empty array to store player data
        var notApprovedRosterMembers = []

        // Iterate through each checkbox in the table that has a 'data-id' attribute
        $('.form-check-input[data-id]').each(function() {
            var playerId = $(this).data('id'); // Get the data-id attribute
            var isApproved = $(this).prop('checked'); // Get the checked state

            if (!isApproved) {
                // Navigate to the parent row of the unchecked checkbox
                var $row = $(this).closest('tr');

                // Find the first name and last name in the specified columns (index 2 and 3)
                var firstName = $row.find('td:eq(2) span span').text().trim();
                var lastName = $row.find('td:eq(3) span span').text().trim();
                notApprovedRosterMembers.push({
                    id: playerId,
                    name : `${firstName} ${lastName}`
                })

                // Log the information
                console.log(`Player not approved: ${firstName} ${lastName}, ID: ${playerId}`);
            }

            // Add the player data to the array
            approvedRosterMembers.push({
                id: playerId,
                approved: isApproved
            });
        });

       if (notApprovedRosterMembers.length > 0) { 
       
           var html = '<div>'
           notApprovedRosterMembers.forEach(function (rosterMember, idx) {

           html += '<li>'
               html += `${rosterMember.name} has not been approved. Please approve roster member or reject with reasons.`
           html += '</li>'

           })
           html += '</div>'
           $('#submissionErrors').append(html)
           $('#submissionErrors').slideDown();
           return;
       }

        // At this point, approvedPlayers contains the data you want
        console.log(approvedRosterMembers); // Log it to the console or do something else with it

        // Ajax call here to approve roster members
        // On success <a href="#"></a>

         var tournamentId = $("#eventSelect").val();
          var teamName = $("#teamName").val()

          var url = `/api/events/itc/approve/${identifier}/tournament/${tournamentId}/team/${teamName}`
          var encodedUrl = encodeURI(url);

       var json = {
       RosterApprovals : approvedRosterMembers}

         $.ajax({
            type: "PUT",
            url: encodedUrl,
            data: JSON.stringify(json),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {

                window.location = "/my-account";
            },
            error: function (result) {
                console.log(result);
            }
        });

       
    });

    // Event listener for changes to the checkbox
    $('#flexSwitchCheckDefault').change(function() {
        updateCheckboxAppearance();
    });

    function updateCheckboxAppearance() {
        if($('#flexSwitchCheckDefault').is(':checked')) {
            // Checkbox is checked, remove the custom class
            $('#flexSwitchCheckDefault').removeClass('unchecked-state');
        } else {
            // Checkbox is unchecked, add the custom class
            $('#flexSwitchCheckDefault').addClass('unchecked-state');
        }
    }

        $('#teamName').on('input', function () {

            var query = $(this).val();
            console.log(query)
            if (query.length >= 3) { // Trigger search when 3 or more characters are typed
                $.ajax({
                    url: '/api/events/search',
                    type: 'GET',
                    data: { searchText: query },
                    success: function (data) {

                        console.log(data)
                        $('#suggestionsContainer').empty();
                        data.forEach(function (item) {
                            // Include item.key in the data-key attribute
                            var suggestionItem = $('<div class="suggestion-item" data-key="' + item.key + '">' + item.name + '</div>');
                            $('#suggestionsContainer').append(suggestionItem);
                            suggestionItem.on('click', function () {
                                $('#teamName').val(item.name); // Set the name in the input field
                                $('#teamName').attr('data-id', item.id); // Set the key as a data attribute on the input
                                $('#teamName').attr('data-key', item.key); // Set the key as a data attribute on the input
                                $('#suggestionsContainer').empty();
                            });
                        });
                    }
                });
            } else {
                $('#suggestionsContainer').empty();
            }
        });

        $('#data-table').on('click', '.btn-danger', function (event) {
            event.stopPropagation(); // Prevent click event from bubbling up to the row
            deleteRow(this); // Call your deleteRow function
        });

        $('#addRowButton').on('click', function () {
            currentMode = 'addPlayer';
            $("#jerseyNumberFormGroup").show()
            currentRow = null;
            clearModalFields();

            // Restore standard role options
            var standardRoles = [
                "Captain",
                "Assistant Captain",
                "Netminder",
                "Forward",
                "Defence"
                // Add other standard roles as necessary
            ];
            var $roleSelect = $('#edit-form #role');
            $roleSelect.empty(); // Remove existing options
            standardRoles.forEach(function (role) {
                $roleSelect.append($('<option>', { value: role, text: role }));
            });

            // Optionally, add a default option
            $roleSelect.prepend($('<option>', { value: '', text: 'Select Role' }).attr('selected', 'selected'));

            $('#editModal').modal('show');
        });

        $('#addBenchOfficialButton').on('click', function () {
            currentMode = 'addbenchOfficial';
            $("#jerseyNumberFormGroup").hide()
            currentRow = null;
            clearModalFields();

            // Clear existing role options and add options for bench officials
            var rolesForBenchOfficial = [
                "Head Coach",
                "Assistant Coach",
                "Bench Staff",
                "Training Staff",
                "Equipment Manager",
                "Physio",
                "Photographer"
            ];
            var $roleSelect = $('#edit-form #role');
            $roleSelect.empty(); // Remove existing options
            rolesForBenchOfficial.forEach(function (role) {
                $roleSelect.append($('<option>', { value: role, text: role }));
            });
            // Optionally, add a default option
            $roleSelect.prepend($('<option>', { value: '', text: 'Select Role' }).attr('selected', 'selected'));

            $('#editModal').modal('show');
        });

        $("#data-table tbody").on("click", "tr", function () {
            currentMode = 'editPlayer';
            currentRow = $(this);

            // Restore standard role options
            var standardRoles = [
                "Captain",
                "Assistant Captain",
                "Netminder",
                "Forward",
                "Defence"
                // Add other standard roles as necessary
            ];
            var $roleSelect = $('#edit-form #role');
            $roleSelect.empty(); // Remove existing options
            standardRoles.forEach(function (role) {
                $roleSelect.append($('<option>', { value: role, text: role }));
            });

            // Optionally, add a default option
            $roleSelect.prepend($('<option>', { value: '', text: 'Select Role' }).attr('selected', 'selected'));

            populateModalFromRow(currentRow);
            @{
                if (!isSubmitted)
                {
                                <text>
                                                                                        $('#editModal').modal('show');
                                                                                    </text>
                }
            }
            
        });

        $("#benchOfficials tbody").on("click", "tr", function () {
            currentMode = 'editBenchOfficial';
            currentRow = $(this);

            // Clear existing role options and add options for bench officials
            var rolesForBenchOfficial = [
                "Head Coach",
                "Assistant Coach",
                "Bench Staff",
                "Training Staff",
                "Equipment Manager",
                "Physio",
                "Photographer"
            ];
            var $roleSelect = $('#edit-form #role');
            $roleSelect.empty(); // Remove existing options
            rolesForBenchOfficial.forEach(function (role) {
                $roleSelect.append($('<option>', { value: role, text: role }));
            });
            // Optionally, add a default option
            $roleSelect.prepend($('<option>', { value: '', text: 'Select Role' }).attr('selected', 'selected'));
            populateModalForBenchOfficial(currentRow);

             @{
                 if (!isSubmitted)
                 {
                                 <text>
                                                                                        $('#editModal').modal('show');
                                                                                    </text>
                 }
             }
        });

        $("#saveChanges").on("click", function () {

            if (currentRow) {
                if (currentMode === 'editPlayer') {
                    updateRowFromModal(currentRow);
                } else if (currentMode === 'editBenchOfficial') {
                    updateBenchOfficialRowFromModal(currentRow);
                }
            } else {
                if (currentMode === 'addPlayer') {
                    // Update player row
                    addNewRowFromModal();
                } else if (currentMode === 'addbenchOfficial') {
                    // Update bench official row
                    addBenchOfficialRowFromModal();
                }
            }
            $('#editModal').modal('hide');
            clearModalFields();
        });

        function addRowToPlayer() {
            // Clear the form fields in the modal
            $('#edit-form').find('input[type="text"], select').val('');

            // Open the modal
            $('#editModal').modal('show');

            // Clear the currentRow variable since this is for adding a new row
            currentRow = null;
        }

        // Handle the save button click
        $(".close-edit").on("click", function () {
            // TODO: Add code to handle the form data, e.g., send an AJAX request
            $('#editModal').modal('hide');
        });

        // When the user clicks anywhere outside of the modal, close it
        $(window).on("click", function (event) {
            var modal = $("#edit-modal");
            if ($(event.target).is(modal)) {
                modal.hide();
            }
        });

        // Handle the form submission
        $("#edit-form").on("submit", function (event) {
            event.preventDefault();
            // TODO: Add code to handle the form data, e.g., send an AJAX request

            $("#edit-modal").hide();
        });

        var nationalityDropdown = $('select[name^="Nationality"]');
        for (var i = 0; i < countries.length; i++) {
            var option = $('<option></option>').attr('value', countries[i]).text(countries[i]);
            nationalityDropdown.append(option);
        }

        $("#addBenchOfficialButtonErrors").hide()

        $('#eventSelect').on('change', function () {
            var selectedValue = $(this).val();
            $.get('/umbraco/surface/events/GetEventInformation', { id: selectedValue }, function (data) {
                $('#eventInformation').html(data);
                 var sanction = $("#sanction").text();
        var classification = sanction.charAt(0).toUpperCase(); // Get the first character and convert to uppercase
        var isTitleEvent = classification === "A";
            if (isTitleEvent) {
                $("#v-pills-guest-tab").hide()
            } else { 
                $("#v-pills-guest-tab").show()
            }
            });

            
        });

        const pickr = Pickr.create({
                el: '#colorPicker',
                theme: 'classic', // or 'monolith', or 'nano'

                swatches: [
                    'rgba(244, 67, 54, 1)',
                    'rgba(233, 30, 99, 0.95)',
                    // ... more colors
                ],

                components: {
                    // Main components
                    preview: true,
                    opacity: true,
                    hue: true,

                    // Input / output Options
                    interaction: {
                        hex: true,
                        input: true,
                    }
                }
            });

        const pickr2 = Pickr.create({
            el: '#colorPicker2',
            theme: 'classic', // or 'monolith', or 'nano'

            swatches: [
                'rgba(244, 67, 54, 1)',
                'rgba(233, 30, 99, 0.95)',
                // ... more colors
            ],

            components: {
                // Main components
                preview: true,
                opacity: true,
                hue: true,

                // Input / output Options
                interaction: {
                    hex: true,
                    input: true,
                }
            },
            strings: {
                save: 'Apply', // Change the text for the save button to 'Apply'
                // ... other string customizations ...
            }
        });

        pickr.on('change', (color, instance) => {
            $('.pcr-button').first().css('--pcr-color', color.toRGBA().toString());
            pickerOneHexVal = color.toHEXA().toString()
            $("#colourOne").val(pickerOneHexVal)

        });

        pickr2.on('change', (color, instance) => {
            $('.pcr-button').last().css('--pcr-color', color.toRGBA().toString());
            pickerTwoHexVal = color.toHEXA().toString()
            $("#colourTwo").val(pickerTwoHexVal)
        });

        $('#colourOne').on('blur change', function () {

            var newColor = $(this).val(); // Get the new color value from the textbox
            pickr.setColor(newColor); // Update the color picker with the new color
        });

        // Event listener for the second textbox using jQuery
        $('#colourTwo').on('blur change', function () {
            var newColor = $(this).val(); // Get the new color value from the textbox
            pickr2.setColor(newColor); // Update the color picker with the new color
        });

         @{
             if (selectedTournament != null && selectedTournament.Id > 0)
             {
                             <text>
                                                                                        var selectedValue = @selectedTournament.Id;
                                                                                        $('#eventSelect').val(selectedValue).change();
                                                                                        $('#eventSelect').prop('disabled', true);

                                                                                    </text>
             }

             if (!string.IsNullOrWhiteSpace(team?.Value<string>("countryIso3")))
             {
                             <text>
                                                                                       
                                                                                    </text>
             }

             if (!string.IsNullOrWhiteSpace(team?.Value<string>("jerseyOneColour")))
             {
                             <text>
                                                                                        setTimeout(function () { 
                                                                                        $('#colourOne').val('@(team?.Value<string>("jerseyOneColour"))').change();}, 500)
                                                                                    </text>
             }

             if (!string.IsNullOrWhiteSpace(team?.Value<string>("jerseyTwoColour")))
             {
                             <text>
                                                                                        setTimeout(function(){
                                                                                        $('#colourTwo').val('@(team?.Value<string>("jerseyTwoColour"))').change();}, 500)

                                                                                    </text>
             }

             if (isSubmitted)
             {
                             <text>
                                                                                 $('#teamName').prop('disabled', true);
                                                                                 $('#teamSignatory').prop('disabled', true);
                                                                                 $('#issuingCountry').prop('disabled', true);

                                                                                 $('.input-group.mb-3').find('button, input').prop('disabled', true);

                                                                             </text>
             }
         }

         if ($("#multipleFilesDropzone").length) {
    var multipleFilesDropzone = new Dropzone("#multipleFilesDropzone", {
        url: "#", // This will be ignored because autoProcessQueue is false
        autoProcessQueue: false, // Disable auto processing
        addRemoveLinks: true,
        dictDefaultMessage: "Drag and drop multiple files here or click",

        // Add custom initialization code here
        init: function() {
            var myDropzone = this;

            // Event listener for when a file is added
            this.on("addedfile", function(file) {
                var labelInput = document.createElement("input");
                labelInput.setAttribute("type", "text");
                labelInput.setAttribute("name", "fileLabel");
                labelInput.setAttribute("class", "file-label-input form-control"); // Add class name for styling
                labelInput.setAttribute("placeholder", "License Number");
                file.previewElement.appendChild(labelInput);
            });

        }
    });

     var queryParams = new URLSearchParams(window.location.search);

        var hasTeam = queryParams.has('team') && queryParams.get('team') !== '';
        
        var hasCreateNew = queryParams.has('create-new') && queryParams.get('create-new') !== '';

        if(hasTeam && hasCreateNew) {

             var tournamentId = $("#eventSelect").val();
             var key = queryParams.get('team');

            $.ajax({
            url: `/api/events/itc/unsubmit/tournament/${tournamentId}/team/${key}`,
            type: 'PUT',
            success: function (data) {
                // Remove the row from the table
                // $.get('/umbraco/surface/events/GetPermissionDocuments', { tournamentId: tournamentId, teamId: teamId }, function (data) {
                //     $('#documents').html(data);
                // });
            },
            error: function (xhr, status, error) {
                console.error("Error: " + error);
                // Show alert that something went wrong
            }
        });
        } 
}
       
    });



</script>