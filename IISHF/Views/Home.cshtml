@using Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.Models.PublishedContent;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<ContentModels.Home>
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@using IISHF.Core.Models
@{
    Layout = "Main.cshtml";
    var id = Model.Id;
    var rootContent = Umbraco.ContentAtRoot().ToList();
    var tournaments = rootContent
        .FirstOrDefault(x => x.Name == "Home")!.Children()?
        .FirstOrDefault(x => x.Name == "Tournaments")!.Children().ToList();
    ;

    var eventYear = DateTime.UtcNow.Year.ToString();

    var cups = tournaments
        .FirstOrDefault(x => x.Name == "European Cups")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var championships = tournaments
        .FirstOrDefault(x => x.Name == "European Championships")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var allEvents = cups.Where(x => x != null).ToList()
        .Concat(championships.Where(x => x != null).ToList())
        .ToList();

    var today = DateTime.UtcNow.Date;
    var currentEvent = allEvents
        .Where(e => e != null && e.HasProperty("EventStartDate") && e.HasProperty("EventEndDate"))
        .FirstOrDefault(e =>
            e.Value<DateTime>("EventStartDate").Date <= today &&
            e.Value<DateTime>("EventEndDate").Date >= today);

    List<IPublishedContent> liveFeed = null;
    List<IPublishedContent> games = null;
    if (currentEvent != null)
    {
        liveFeed = currentEvent.Children()
            .OfType<IPublishedContent>()  // Ensure it's published content
            .Where(c => c.ContentType.Alias == "liveFeeds")
            .Where(c => c.Value<DateTime>("LiveFeedDateTime").Date == today)  // Filter by LiveFeedDateTime date
            .OrderByDescending(c => c.Value<DateTime>("LiveFeedDateTime"))
            .ToList();

        games = currentEvent.Children()
            .OfType<IPublishedContent>()  // Ensure it's published content
            .Where(c => c.ContentType.Alias == "game")
            .OrderByDescending(c => c.Value<DateTime>("ScheduleDateTime"))
            .ToList();

        if (liveFeed != null)
        {
            // Do something with the live feed
        }
    }

    var video = allEvents;
}

<section class="home-header-section">
    <div class="container custom-container">
        <div class="row">
            <div class="col-12 col-sm-12 col-md-7 col-lg-7 col-xl-7">
                <h1 class="fs63 orange mt-5">Welcome to <br />Inline Skater Hockey</h1>
                <p class="sub-heading mt-5 serif">A fast, physical, dynamic, strategic team sport that requires great concentration and coordination of all team members.</p>
            </div>
            <div class="col-xs-12 col-sm-12 col-md-5 col-lg-5 text-center">
                <img class="img img-fluid mx-auto" src="../images/netminder.png" />
            </div>
        </div>
    </div>
</section>

<section class="home-event-section" style="display: none">
    @{
        if (games != null)
        {
            foreach (var game in games.OrderBy(x => x.Value<int>("gameNumber")))
            {
                var homeTeamContent = currentEvent.Children().Where(x => x.ContentType.Alias == "team").FirstOrDefault(x => x.Name == game.Value<string>("homeTeam"));

                var awayTeamContent = currentEvent.Children().Where(x => x.ContentType.Alias == "team").FirstOrDefault(x => x.Name == game.Value<string>("awayTeam"));

                var homeLogo = homeTeamContent?.Value<IPublishedContent>("image")?.Url() ?? string.Empty;
                var awayLogo = awayTeamContent?.Value<IPublishedContent>("image")?.Url() ?? string.Empty;

                var gameDate = game.Value<DateTime>("scheduleDateTime");
                var formattedDateTime = gameDate.ToString("dd.MM.yyyy HH:mm");
                var remarks = !string.IsNullOrWhiteSpace(game.Value<string>("group").Trim())
                ? $"Group {game.Value<string>("group").Trim()}"
                : game.Value<string>("remarks").Trim();

                var homeScore = game.Value<string>("homeScore");
                var awayScore = game.Value<string>("awayScore");

                if (homeTeamContent != null || awayTeamContent != null)
                {
                    <div class="card">
                        <div class="card-body">
                            <div>
                                <h6 class="card-title text-center">@formattedDateTime</h6>
                                <h6 class="card-title text-center">@remarks</h6>
                            </div>
                            <div class="container">
                                <div class="row">
                                    <div class="col-6">
                                        @{
                                            if (homeTeamContent != null)
                                            {
                                                <img src="@homeLogo" alt="" style="height: 45px; width: 45px" />
                                            }
                                        }
                                    </div>
                                    <div class="col-6">@homeScore</div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        @{
                                            if (awayTeamContent != null)
                                            {
                                                <img src="@awayLogo" alt="" style="height: 45px; width: 45px" />
                                            }
                                        }
                                    </div>
                                    <div class="col-6">@awayScore</div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        }
    }
</section>

@{
    if (currentEvent != null && liveFeed != null)
    {
        <div class="container mt-3">
            <div class="row" id="live-feed-container">
                <h1 class="text-center mb-4">IISHF @currentEvent.Parent.Name @currentEvent.Name <span class="orange">Live</span> feed</h1>
                @{

                    if (!liveFeed.Any(x => x.Value<bool>("ShowInSite")))
                    {
                        <h3 class="text-center">No video feeds are currently available for this event</h3>
                    }
                    else if (liveFeed.Count(x => x.Value<bool>("ShowInSite")) == 1)
                    {
                        var link = liveFeed.FirstOrDefault().Value<Umbraco.Cms.Core.Models.Link>("liveFeedUrl");
                        var feedFromTime = liveFeed.FirstOrDefault().Value<DateTime>("liveFeedDateTime").ToString("F");
                        var feedId = $"feed{liveFeed.FirstOrDefault().Id}";

                        <h3>@liveFeed.FirstOrDefault().Name</h3>
                        <h5>Feed Time CET: @feedFromTime</h5>

                        if (link.Url.ToLower().Contains("youtube")) 
                        {
                            var src = $"https://www.youtube.com/embed/{@link.Url.Split('/').Last()}";
                            <div class="row mb-5">
                                <iframe width="640" height="420" src="@src" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                            </div>
                        }

                        if (link.Url.ToLower().Contains("sportdeutschland") || link.Url.ToLower().Contains("sporteurope"))
                        {
                            <iframe src="@link.Url" width=640 height="420" frameborder=0 allowfullscreen></iframe>
                        }

                        if (link.Url.ToLower().Contains("twitch.tv"))
                        {
                            var lower = link.Url.ToLower();
                            string twitchSrc;

                            // Try to extract a VOD ID from ".../videos/1234567890"
                            var vodIdPart = lower.Contains("/videos/")
                            ? lower.Split("/videos/")[1].Split('?')[0]  // take number before query string
                            : null;

                            if (!string.IsNullOrWhiteSpace(vodIdPart) && long.TryParse(vodIdPart, out var vodId))
                            {
                                // Specific VOD embed
                                twitchSrc = $"https://player.twitch.tv/?video=v{vodId}&parent=iishf.com&parent=www.iishf.com&autoplay=false&muted=false";
                            }
                            else
                            {
                                // Fallback → live channel
                                // Channel name is always the part after twitch.tv/
                                var parts = lower.Split(new[] { "twitch.tv/" }, StringSplitOptions.None);
                                var channelName = parts.Length > 1 ? parts[1].Split('/')[0] : "wolfpack_ternitz";

                                twitchSrc = $"https://player.twitch.tv/?channel={channelName}&parent=iishf.com&parent=www.iishf.com&autoplay=true&muted=true";
                            }

                            <div class="row mb-5">
                                <iframe width="640" height="420" src="@twitchSrc" title="Twitch player" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                            </div>
                        }

                    }
                    else
                    {
                        foreach (var feed in liveFeed.Where(x => x.Value<bool>("ShowInSite")))
                        {
                            var link = feed.Value<Umbraco.Cms.Core.Models.Link>("liveFeedUrl");
                            var feedFromTime = feed.Value<DateTime>("liveFeedDateTime").ToString("F");
                            var feedId = $"feed{feed.Id}";

                            <div class="col-md-4 feed-item" id="@feedId" style="display:none;">
                                <h3>@feed.Name</h3>
                                <h5>Feed Time CET: @feedFromTime</h5>
                                @{
                                    if (link.Url.ToLower().Contains("youtube"))
                                    {
                                        var src = $"https://www.youtube.com/embed/{@link.Url.Split('/').Last()}";
                                        <iframe width="100%" height="210" src="@src" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    }
                                    else if (link.Url.ToLower().Contains("sportdeutschland") || link.Url.ToLower().Contains("sporteurope"))
                                    {
                                        <iframe src="@link.Url" width="100%" height="210" frameborder="0" allowfullscreen></iframe>
                                    }
                               }
                            </div>
                        }
                    }
                }
            </div>
        </div>
    }
}



@await Html.PartialAsync("News/LatestNewsLimit6")

@await Html.PartialAsync("~/Views/Partials/Statements/MissionAndValues.cshtml")


<section id="member-federations" class="home-member-section">
    <div class="Container">
        <div class="row">
            <div class="col-12 col-sm-12 col-md-12 col-lg-12 mb-2">
                <h2 class="text-center">
                    Our Member Federations
                </h2>
            </div>
        </div>
    </div>
    @{
        if (Model.Value<IPublishedContent>("carousel") != null)
        {
            @await Html.PartialAsync("~/Views/Partials/Galleries/Gallery.cshtml")
        }
    }
</section>


@Html.Partial("~/Views/Partials/Contact/ContactForm.cshtml", new ContactFormViewModel())

<script>
    $(document).ready(function () {

        // ToDo
        // Move both video video feeds and home event section into their own 
        // respective views show when fully rendered. 

        // At a glance scores view needs to be pulled every minute as per events
        // and all in one page. 
        function parseFeedTime(feedTimeStr) {
            // Directly parse the feed time string into a Date object
            let date = new Date(feedTimeStr);
            return date;
        }

        function showFeed(feedTime) {
            const currentTime = new Date(); // Current time in user's local timezone
            const timeDifference = Math.abs(feedTime.getTime() - currentTime.getTime());
            console.log(`Feed Time: ${feedTime}, Current Time: ${currentTime}, Difference: ${timeDifference} ms`);
            return timeDifference <= 3000000; // Adjusted to 50 minutes difference
        }

        function updateVisibleFeeds() {
            const feedItems = $("#live-feed-container .feed-item").toArray();
            console.log(`Total feeds loaded: ${feedItems.length}`);

            const relevantFeeds = [];
            feedItems.forEach(item => {
                const feedTimeText = $(item).find("h5").text().split("Feed Time CET: ")[1];
                const feedTime = parseFeedTime(feedTimeText);
                if (showFeed(feedTime)) {
                    relevantFeeds.push(item);
                }
            });

            console.log(`Relevant feeds found: ${relevantFeeds.length}`);

            // Hide all feeds first
            $(feedItems).hide();

            // Show only the relevant feeds (up to 3)
            $(relevantFeeds.slice(0, 3)).show();
        }

        updateVisibleFeeds(); // Initial update on page load

        setInterval(updateVisibleFeeds, 60000); // Update visibility every minute

        const section = $('.home-event-section');
        let isDown = false;
        let startX;
        let scrollLeft;

        section.mousedown(function (e) {
            isDown = true;
            section.addClass('active');
            startX = e.pageX - section.offset().left;
            scrollLeft = section.scrollLeft();
            section.css('cursor', 'grabbing');
        });

        section.mouseleave(function () {
            isDown = false;
            section.removeClass('active');
            section.css('cursor', 'grab');
        });

        section.mouseup(function () {
            isDown = false;
            section.removeClass('active');
            section.css('cursor', 'grab');
        });

        section.mousemove(function (e) {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - section.offset().left;
            const walk = (x - startX) * 3; // Adjust the scroll speed
            section.scrollLeft(scrollLeft - walk);
        });

    });
</script>
