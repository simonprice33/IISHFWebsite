@using IISHF.Core.Controllers
@using MailKit.Search
@using IISHF.Helpers
@model IISHF.Core.Models.GroupRankingsViewModel

@{
    var groups = Model.Rankings.GroupBy(x => x.Group);
}

<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-5 standingheader">Standings</h1>
            @{

                if (groups.Count() == 0)
                    {
                        <h3 class="text-center">Awaiting Group Information</h3>
                    }
                
                if (groups.Count() == 1)
                {
                    <table class="table table-striped table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
                        <thead>
                            <tr>
                                <th></th>
                                <th class="rank"></th>
                                <th class="teamname"></th>
                                <th>G</th>
                                <th>W</th>
                                <th>L</th>
                                <th>T</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>+/-</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var team in groups.FirstOrDefault().OrderBy(x => x.GroupPlacement)
                    .ThenByDescending(x => x.Points)
                    .ThenByDescending(x => x.TieWeight)
                    .ThenByDescending(x => x.Wins)
                    .ThenByDescending(x => x.GoalsFor)
                    .ThenByDescending(x => x.GoalsAgainst)
                    .ThenByDescending(x => x.Differnce))
                            {
                                <tr>
                                    <td class="align-middle rank">@team.GroupPlacement.ToOrdinal()</td>

                                    @{
                                        if (string.IsNullOrWhiteSpace(@team.TeamLogoUrl))
                                        {
                                            <td colspan="2" class="align-middle teamname"><strong>@team.TeamName</strong></td>
                                        }
                                        else
                                        {
                                            <td>
                                                <img class="img img-fluid" style="height: 50px; width: 50px" src="@team.TeamLogoUrl" alt="@team.TeamName" />
                                            </td>
                                            <td class="align-middle teamname"><strong>@team.TeamName</strong></td>
                                        }
                                    }

                                    <td class="align-middle">@team.Games</td>
                                    <td class="align-middle">@team.Wins</td>
                                    <td class="align-middle">@team.Losses</td>
                                    <td class="align-middle">@team.Ties</td>
                                    <td class="align-middle">@team.GoalsFor</td>
                                    <td class="align-middle">@team.GoalsAgainst</td>
                                    <td class="align-middle">@team.Differnce</td>
                                    <td class="align-middle">@team.Points</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    foreach (var group in groups.OrderBy(x => x.Key))
                    {
                        <h1 class="mb-3">Group @group.Key</h1>
                        <table class="table table-striped table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th>G</th>
                                    <th>W</th>
                                    <th>L</th>
                                    <th>T</th>
                                    <th>GF</th>
                                    <th>GA</th>
                                    <th>+/-</th>
                                    <th>Pts</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var team in group.OrderBy(x => x.GroupPlacement)
                           .ThenByDescending(x => x.Points)
                           .ThenByDescending(x => x.TieWeight)
                           .ThenByDescending(x => x.Wins)
                           .ThenByDescending(x => x.GoalsFor)
                           .ThenByDescending(x => x.GoalsAgainst)
                           .ThenByDescending(x => x.Differnce))
                                {
                                    <tr>
                                        <td class="align-middle">@team.GroupPlacement.ToOrdinal()</td>

                                        @{
                                            if (string.IsNullOrWhiteSpace(@team.TeamLogoUrl))
                                            {
                                                <td colspan="2" class="align-middle"><strong>@team.TeamName</strong></td>
                                            }
                                            else
                                            {
                                                <td>
                                                    <img class="img img-fluid" style="height: 50px; width: 50px" src="@team.TeamLogoUrl" alt="@team.TeamName" />
                                                </td>
                                                <td class="align-middle"><strong>@team.TeamName</strong></td>
                                            }
                                        }

                                        <td class="align-middle">@team.Games</td>
                                        <td class="align-middle">@team.Wins</td>
                                        <td class="align-middle">@team.Losses</td>
                                        <td class="align-middle">@team.Ties</td>
                                        <td class="align-middle">@team.GoalsFor</td>
                                        <td class="align-middle">@team.GoalsAgainst</td>
                                        <td class="align-middle">@team.Differnce</td>
                                        <td class="align-middle">@team.Points</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                }
            }
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Initialize Tablesaw
        $(document).trigger("enhance.tablesaw");
    });
</script>


<script>
    $(document).ready(function () {
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/dataHub") // Ensure this matches your SignalR hub endpoint
            .configureLogging(signalR.LogLevel.Information)
            .build();

        connection.start().then(function () {
            console.log("SignalR connected");
        }).catch(function (err) {
            return console.error(err.toString());
        });

        connection.on("UpdatePlayerStats", function (year, shortCode, group) {

            //Triggers a GET of the schedule and results again,
            //ToDo GET teams and logo url sent back instead
            $.get('/umbraco/surface/events/GetGroupRankings', { year: year, titleEvent: shortCode }, function (data) {
                $('#groupRankingsContainer').html(data);
            });
        });
    });
</script>