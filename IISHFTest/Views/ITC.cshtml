@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<ContentModels.ITC>
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using System.Globalization
@using Umbraco.Cms.Core.Security
@inject IMemberManager MemberManager
@{
    Layout = "Main.cshtml";
    var id = Model.Id;
    var rosterMembers = Umbraco.Content(id).Children().Where(x => x.ContentType.Alias == "roster").ToList();
    var players = rosterMembers.Where(x => !x.Value<bool>("isBenchOfficial")).ToList();
    var benchOfficials = rosterMembers.Where(x => x.Value<bool>("isBenchOfficial")).ToList();
    var heroImageObj = Model.Value<IPublishedContent>("heroImage");
    var heroImage = heroImageObj != null ? heroImageObj.Url() : "";

    var eventYear = DateTime.Now.Year.ToString();

    var rootContent = Umbraco.ContentAtRoot().ToList();
    var tournaments = rootContent
        .FirstOrDefault(x => x.Name == "Home")!.Children()?
        .FirstOrDefault(x => x.Name == "Tournaments")!.Children().ToList();

    var cups = tournaments
        .FirstOrDefault(x => x.Name == "European Cups")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var championships = tournaments
        .FirstOrDefault(x => x.Name == "European Championships")
        .Children()
        .Select(x => x.Children.FirstOrDefault(x => x.Name == eventYear))
        .ToList();

    var allEvents = cups.Where(x => x != null).ToList().Concat(championships.Where(x => x != null).ToList()).ToList().Select(x => new
    {
        EventName = x.Parent.Name,
        Id = x.Id
    });

    string[] priorityCountries = { "United Kingdom", "Germany", "Switzerland", "Austria", "Denmark", "Ukraine" };

    // Get all countries and ISO codes
    var countries = CultureInfo.GetCultures(CultureTypes.SpecificCultures)
        .Select(c => new RegionInfo(c.Name))
        .Distinct()
        .Select(x => new
        {
            Country = x.EnglishName,
            ISO3 = x.ThreeLetterISORegionName
        })
        .Where(x => !string.IsNullOrEmpty(x.ISO3))
        .OrderBy(x => Array.IndexOf(priorityCountries, x.Country) == -1 ? int.MaxValue : Array.IndexOf(priorityCountries, x.Country))
        .ThenBy(x => x.Country);

    // Check if the user is logged in
    var isLoggedIn = User.Identity.IsAuthenticated;
    MemberIdentityUser user = null;

    if (isLoggedIn)
    {
        // Retrieve user details
        user = await MemberManager.GetCurrentMemberAsync();
    }

    Guid.TryParse(Context.Request.Query["team"].ToString(), out var teamInformation);
    if (teamInformation == Guid.Empty)
    {
        // build itc information from team information for event
    }
}

<div class="jumbotron jumbotron-fluid hero hero-large" style="background-image: url('@heroImage')">
    <div class="overlay"></div>
    <div class="inner">
        <div class="container custom-container">
            <h1 class="display-4">@Model.Value("heroTitle")</h1>
            <p class="lead">@Model.Value("heroSubtitle")</p>
        </div>
    </div>
</div>

<div class="container custom-container mt-5 mb-5">
    <div class="row">

        <div class="col-md-3">
            <!-- Tabs nav -->
            <div class="nav flex-column nav-pills nav-pills-custom" id="v-pills-tab" role="tablist" aria-orientation="vertical">

                <span class="nav-link mb-3 p-3 shadow" id="v-pills-players-tab">
                    <select id="eventSelect" class="form-control">
                        @{
                            <option value="">Select Event for @DateTime.Now.Year.ToString()</option>

                            foreach (var iishfEvent in allEvents)
                            {
                                <option value="@iishfEvent.Id">@iishfEvent.EventName</option>
                            }
                        }
                    </select>

                    <div id="eventInformation"></div>
                </span>
                <a class="nav-link mb-3 p-3 shadow active" id="v-pills-team-tab" data-bs-toggle="pill" href="#v-pills-team" role="tab" aria-controls="v-players-team" aria-selected="true">
                    <span class="font-weight-bold small text-uppercase">Team Information</span>
                </a>
                <a class="nav-link mb-3 p-3 shadow" id="v-pills-players-tab" data-bs-toggle="pill" href="#v-pills-players" role="tab" aria-controls="v-players-players" aria-selected="true">
                    <span class="font-weight-bold small text-uppercase">Players</span>
                </a>
                <a class="nav-link mb-3 p-3 shadow" id="v-pills-bench-tab" data-bs-toggle="pill" href="#v-pills-bench" role="tab" aria-controls="v-bench-bench" aria-selected="true">
                    <span class="font-weight-bold small text-uppercase">Bench Officials</span>
                </a>
                <a class="nav-link mb-3 p-3 shadow" id="v-pills-submit-tab" data-bs-toggle="pill" href="#v-pills-submit" role="tab" aria-controls="v-submit-submit" aria-selected="true">
                    <span class="font-weight-bold small text-uppercase">Validate and Submit</span>
                </a>
            </div>

        </div>
        <div class="col-md-9">
            <!-- Tabs content -->
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade shadow rounded bg-white show active p-5" id="v-pills-team" role="tabpanel" aria-labelledby="v-pills-team-tab">
                    <div class="row form-group">
                        <div class="col-12 col-md-10">
                            <input type="text" class="form-control" placeholder="Team Name" id="teamName" />
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-12 col-md-10">
                            <input type="text" class="form-control" placeholder="Team Signatory" id="teamSignatory" />
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-12 col-md-10">
                            <input type="text" class="form-control" placeholder="Issuing Country" id="issuingCountry" />
                        </div>
                    </div>
                    <div class="row form-group">
                        <label for="jerseyOneColour" class="col-12 col-md-2 col-form-label">First Jersey Colour:</label>
                        <div class="col-12 col-md-8">
                            <div id="colorPicker" class="color-picker-container"></div>
                        </div>
                    </div>
                    <div class="row form-group">
                        <label for="jerseyTwoColour" class="col-12 col-sm-4 col-md-2 col-form-label">Second Jersey Colour:</label>
                        <div class="col-12 col-md-10">
                            <div id="colorPicker2" class="color-picker-container"></div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-players" role="tabpanel" aria-labelledby="v-pills-players-tab">
                    <div class="table-responsive">
                        <table id="data-table" class="table table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
                            <thead>
                                <tr>
                                    <th style="width: 150px">License</th>
                                    <th>Role</th>
                                    <th>Player Name</th>
                                    <th style="width: 50px">Jersey Number</th>
                                    <th>Date of Birth</th>
                                    <th>Nationality</th>
                                    <th>Gender</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="formRows">
                                @for (int i = 0; i < players.Count(); i++)
                                {
                                    <tr>
                                        <td>
                                            @*<input type="text" class="form-control" id="License" name="License[]" value="@players[i].Value("licenseNumber")" />*@
                                            <span>@players[i].Value("licenseNumber")</span>
                                        </td>
                                        <td>

                                            <span>@players[i].Value("role")</span>
                                        </td>
                                        <td>
                                            
                                            <span>@players[i].Value("playerName")</span>
                                        </td>
                                        <td>
                                            <!-- Label and input for Jersey Number -->
                                            @*<input type="text" class="form-control" id="JerseyNumber" name="JerseyNumber[]" oninput="validateNumber(this)" value="@players[i].Value("jerseyNumber")" />*@
                                            <span>@players[i].Value("jerseyNumber")</span>
                                        </td>
                                        <td>
                                            <!-- Label and input for Date of Birth -->
                                            @{
                                                var dob = players[i].Value<DateTime>("dateOfBirth").ToString("dd.MM.yyyy");
                                            }
                                            @*<input type="text" class="form-control" id="DateOfBirth" name="DateOfBirth[]" placeholder="DD.MM.YYYY" value="@dob" />*@
                                            <span>@dob</span>
                                        </td>
                                        <td>
                                            <!-- Label and select for Nationality -->
                                            @*<select class="form-control" id="Nationality" name="Nationality[]">
                                        <option value="">Nationality</option>
                                        @foreach (var country in countries)
                                        {
                                        var isSelected = country.Country.Equals(players[i].Value<string>("nationality"));
                                        <option value="@country.ISO3" selected="@isSelected">@country.Country</option>
                                        }
                                        </select>*@
                                            <span>@players[i].Value("nationality")</span>
                                        </td>
                                        <td>
                                            
                                            <span>@players[i].Value("gender")</span>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger" onclick="deleteRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <button type="button" onclick="addRowToPlayer()">Add Row</button>
                    <button type="submit" onclick="validateForms()">Validate</button>

                </div>

                <div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-bench" role="tabpanel" aria-labelledby="v-pills-bench-tab">
                    <table id="benchOfficials" class="table table-hover mb-5 tablesaw" data-tablesaw-mode="stack">
                        <thead>
                            <tr>
                                <th style="width: 150px">License</th>
                                <th>Role</th>
                                <th>Official Name</th>
                                <th>Date of Birth</th>
                                <th>Nationality</th>
                                <th>Gender</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="formRowsBench">
                            @for (int i = 0; i < benchOfficials.Count(); i++)
                            {
                                <tr>
                                    <td><input type="text" class="form-control" name="BenchLicense[]" value="@benchOfficials[i].Value("licenseNumber")" /></td>
                                    <td>
                                        <select class="form-control" name="BenchRole[]">
                                            <option value="Captain" selected="@(benchOfficials[i].Value<string>("role") == "Captain")">Captain</option>
                                            <option value="Assistant Captain" selected="@(benchOfficials[i].Value<string>("role") == "Assistant Captain")">Assistant Captain</option>
                                            <option value="Netminder" selected="@(benchOfficials[i].Value<string>("role") == "Netminder")">Netminder</option>
                                            <option value="Player" selected="@(benchOfficials[i].Value<string>("role") == "Player")">Player</option>
                                            <option value="" selected="@(string.IsNullOrWhiteSpace(benchOfficials[i].Value<string>("role")))">Role</option>
                                        </select>
                                    </td>
                                    <td><input type="text" class="form-control" name="BenchOfficialName[]" value="@benchOfficials[i].Value("playerName")" /></td>
                                    <td>
                                        @{
                                            var dob = benchOfficials[i].Value<DateTime>("dateOfBirth").ToString("dd.MM.yyyy");
                                        }
                                        <input type="text" class="form-control" name="BenchDateOfBirth[]" placeholder="DD.MM.YYYY" value="@dob" />
                                    </td>
                                    <td>
                                        <select class="form-control" name="BenchNationality[]">
                                            <option value="">Nationality</option>
                                            @foreach (var country in countries)
                                            {
                                                var isSelected = country.Country.Equals(benchOfficials[i].Value<string>("nationality"));
                                                <option value="@country.ISO3" selected="@isSelected">@country.Country</option>
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control" name="BenchGender[]">
                                            <option value="Male" selected="@(benchOfficials[i].Value<string>("gender") == "Male")">Male</option>
                                            <option value="Female" selected="@(benchOfficials[i].Value<string>("gender") == "Female")">Female</option>
                                            <option value="" selected="@(string.IsNullOrWhiteSpace(benchOfficials[i].Value<string>("gender")))">Gender</option>
                                        </select>
                                    </td>
                                    <button type="button" class="btn btn-danger" onclick="deleteRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div id="addBenchOfficialButtonErrors" class="alert alert-danger" role="alert">
                        <h3>Cannot add more than 8 bench officials</h3>
                    </div>
                    <button id="addBenchOfficialButton" type="button">Add Row</button>

                </div>
                <div class="tab-pane fade shadow rounded bg-white show p-5" id="v-pills-submit" role="tabpanel" aria-labelledby="v-pills-submit-tab">
                    <button type="submit" onclick="validateForms()">Validate</button>
                    <button onclick="saveAsDraft()">Save Draft</button>
                    <button onclick="submit()">Submit</button>
                    <div id="submissionErrors" class="alert alert-danger mb-3" role="alert">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">Edit Data</h5>
                <button type="button" class="close close-edit" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- The form inside the modal -->
                <form id="edit-form">
                    <div class="form-group">
                        <label for="license">License:</label>
                        <input type="text" class="form-control" id="license" name="license">
                    </div>
                    <div class="form-group">
                        <label for="role">Role:</label>
                        <select class="form-control" id="role" name="role">
                                                <option value="">Select Role</option>
                                                <option value="Captain">Captain</option>
                                                <option value="Assistant Captain">Assistant Captain</option>
                                                <option value="Netminder">Netminder</option>
                                                <!-- Add other role options here -->
                                            </select>
                    </div>
                    <div class="form-group">
                        <label for="playerName">Name:</label>
                        <input type="text" class="form-control" id="playerName" name="playerName">
                    </div>
                    <div class="form-group">
                        <label for="jerseyNumber">Jersey Number:</label>
                        <input type="text" class="form-control" id="jerseyNumber" name="jerseyNumber">
                    </div>
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth:</label>
                        <input type="text" class="form-control" id="dateOfBirth" name="dateOfBirth">
                    </div>
                    <div class="form-group">
                        <label for="nationality">Nationality:</label>
                        <select class="form-control" id="nationality" name="nationality">
                        <option value="">Nationality</option>
                        @foreach (var country in countries)
                        {
                                <option value="@country.Country">@country.Country</option>
                        }
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender:</label>
                        <!-- Label and select for Gender -->
                        <select class="form-control" id="gender" name="gender">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <!-- Add other gender options here -->
                        </select>
                    </div>

                    <!-- Add more input fields as necessary -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-edit" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveChanges">Update table</button>
            </div>
        </div>
    </div>
</div>


<script>

    var countries = @Html.Raw(Json.Serialize(@countries));
    $("#submissionErrors").hide();

    var deletedLicenseNumbers = [];
    var selectedRoles = [];
    var allErrors = [];
    var licenseNumbers = [];
    var benchOfficialLicenseNumbers = []
    var licenseNumbersEncountered = [];
    var jerseyNumbersEncountered = [];

    function deleteRow(button) {
        var row = button.parentNode.parentNode;
        var licenseNumber = row.querySelector('input[name="License[]"]').value;

        // Remove the row from the table
        row.parentNode.removeChild(row);

        // Add the license number to the array
        deletedLicenseNumbers.push(licenseNumber);
    }

    function validateAllLicenses() {
        var licenseInputs = $('input[name^="License"]');
        var licenseValues = [];

        licenseInputs.each(function () {
            var value = $(this).val().trim();
            licenseValues.push(value);
        });

        licenseInputs.each(function () {
            var value = $(this).val().trim();
            var isDuplicate = licenseValues.indexOf(value) !== licenseValues.lastIndexOf(value);

            if (isDuplicate) {
                $(this).addClass('is-duplicate');
            } else {
                $(this).removeClass('is-duplicate');
            }
        });
    }

    function validateAllJerseyNumbers() {
        var jerseyInputs = $('input[name^="JerseyNumber"]');
        var jerseyValues = [];

        jerseyInputs.each(function () {
            var value = $(this).val().trim();
            jerseyValues.push(value);
        });

        jerseyInputs.each(function () {
            var value = $(this).val().trim();
            var isDuplicate = jerseyValues.indexOf(value) !== jerseyValues.lastIndexOf(value);

            if (isDuplicate) {
                $(this).addClass('is-duplicate');
            } else {
                $(this).removeClass('is-duplicate');
            }
        });
    }

    function validateRoles() {
        var roleSelects = $('select[name^="Role"]');
        var roleSelections = [];

        roleSelects.each(function () {
            var selectedRole = $(this).val();
            roleSelections.push(selectedRole);
        });

        roleSelects.each(function () {
            var selectedRole = $(this).val();
            var isDuplicate = roleSelections.indexOf(selectedRole) !== roleSelections.lastIndexOf(selectedRole);

            if (isDuplicate && selectedRole) {
                $(this).addClass('is-duplicate-role');
            } else {
                $(this).removeClass('is-duplicate-role');
            }
        });
    }

    function validateForm() {
        var isValid = true;
        var captains = [];
        var assistantCaptains = [];

        // Clear any previous error indicators
        $('#formRows tr').removeClass('table-danger');
        $('#submissionErrors').empty().hide();

        // Reset the encountered numbers before validation
        licenseNumbersEncountered = [];
        jerseyNumbersEncountered = [];

        // First, collect all license and jersey numbers and roles
        $('#formRows tr').each(function (index, row) {
            var currentRow = $(row);
            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var jerseyNumber = currentRow.find("td:eq(3) span span").text().trim();
            var role = currentRow.find("td:eq(1) span span").text().trim();

            if (licenseNumber) {
                licenseNumbersEncountered.push({ number: licenseNumber, index: index });
            }
            if (jerseyNumber) {
                jerseyNumbersEncountered.push({ number: jerseyNumber, index: index });
            }

            // Collect roles
            if (role === 'Captain') {
                captains.push(index);
            } else if (role === 'Assistant Captain') {
                assistantCaptains.push(index);
            }
        });

        // Check for duplicates
        var duplicateLicenseNumbers = findDuplicates(licenseNumbersEncountered);
        var duplicateJerseyNumbers = findDuplicates(jerseyNumbersEncountered);

        // Check if there are more than one Captain or Assistant Captain
        var isDuplicateCaptain = captains.length > 1;
        var isDuplicateAssistantCaptain = assistantCaptains.length > 1;

        // Now validate each row
        $('#formRows tr').each(function (index, row) {
            var currentRow = $(row);
            var licenseNumber = currentRow.find("td:eq(0) span span").text().trim();
            var role = currentRow.find("td:eq(1) span span").text().trim();
            var playerName = currentRow.find("td:eq(2) span span").text().trim();
            var jerseyNumber = currentRow.find("td:eq(3) span span").text().trim();
            var dateOfBirth = currentRow.find("td:eq(4) span span").text().trim();
            var nationality = currentRow.find("td:eq(5) span span").text().trim();
            var gender = currentRow.find("td:eq(6) span span").text().trim();
            var rowErrors = validateRow(licenseNumber, jerseyNumber, playerName, role, dateOfBirth, nationality, gender, index);

            // Add errors for duplicates
            if (duplicateLicenseNumbers.has(licenseNumber)) {
                rowErrors.push('Duplicate license number: ' + licenseNumber);
            }
            if (duplicateJerseyNumbers.has(jerseyNumber)) {
                rowErrors.push('Duplicate jersey number: ' + jerseyNumber);
            }

            // Add errors for duplicate roles
            if (role === 'Captain' && isDuplicateCaptain) {
                rowErrors.push('There can only be one Captain');
            }
            if (role === 'Assistant Captain' && isDuplicateAssistantCaptain) {
                rowErrors.push('There can only be one Assistant Captain');
            }

            // Highlight the row if there are errors
            if (rowErrors.length > 0) {
                isValid = false;
                currentRow.addClass('table-danger');
                allErrors.push({
                    row: index + 1,
                    name: playerName,
                    errors: rowErrors
                });
            }
        });

        return isValid;
    }

    function validateRow(licenseNumber, jerseyNumber, playerName, role, dateOfBirth, nationality, gender, rowIndex) {
        var errors = [];
        if (!licenseNumber || isNaN(parseInt(licenseNumber))) {
            errors.push('Invalid license number at row ' + (rowIndex + 1));
        }
        if (!jerseyNumber || isNaN(parseInt(jerseyNumber))) {
            errors.push('Invalid jersey number at row ' + (rowIndex + 1));
        }

        if (!playerName || playerName === "") {
            errors.push('Player name is required');
        }

        if (!dateOfBirth || dateOfBirth === "" || dateOfBirth === "01.01.0001") {
            errors.push('Date of birth is requried');
        }

        if (!nationality || nationality === "") {
            errors.push('Nationality is requried');
        }

        if (!role || role === "") {
            errors.push('Roster member role is requried');
        }

        if (!gender || gender === "") {
            errors.push('Roster member gender is requried');
        }

        return errors;
    }

    function findDuplicates(numbers) {
        var seen = new Set();
        var duplicates = new Set();

        numbers.forEach(item => {
            if (seen.has(item.number)) {
                duplicates.add(item.number);
            }
            seen.add(item.number);
        });

        return duplicates;
    }

    function validateBenchOfficialsForm() {
        var isValid = true;
        var errors = [];
        var rowCount = $('#formRowsBench tr').length;

        for (var i = 0; i < rowCount; i++) {
            $('#formRowsBench tr').eq(i).removeClass('table-danger');
            var rowErrors = validateBenchOfficialsRow(i);
            var officialName = $('input[name="BenchOfficialName[]"]').eq(i).val();
            var licenseNumber = $('input[name="BenchLicense[]"]').eq(i).val();
            // Check for duplicate license numbers
            benchOfficialLicenseNumbers.push({
                role: "Bench Official License",
                name: officialName,
                license: licenseNumber
            })

            if (rowErrors.length > 0) {
                isValid = false;
                // Add class only to rows in the tbody, excluding the thead
                $('#formRowsBench tr').eq(i).addClass('table-danger');
                allErrors.push({
                    role: "Bench Issues",
                    name: officialName,
                    rowErrors: rowErrors
                });
            }
        }

        var licenseNumberMap = {};
        var duplicateLicenseNumbers = {};

        benchOfficialLicenseNumbers.forEach(function (item) {
            var licenseNumber = item.license;
            var name = item.name.trim(); // Trim to handle empty or whitespace-only names

            if (name !== '' && licenseNumber !== '') {
                if (!licenseNumberMap[licenseNumber]) {
                    licenseNumberMap[licenseNumber] = [];
                }

                licenseNumberMap[licenseNumber].push(name);

                if (licenseNumberMap[licenseNumber].length > 1) {
                    duplicateLicenseNumbers[licenseNumber] = true;
                }
            }
        });

        for (var number in licenseNumberMap) {
            if (licenseNumberMap.hasOwnProperty(number)) {
                var names = licenseNumberMap[number];

                if (names.length > 1 && duplicateLicenseNumbers[number]) {

                    allErrors.push({
                        role: "Duplicate license numbers",
                        name: number,
                        rowErrors: names
                    });
                }
            }
        }

        if (!isValid) {
            $("#submissionErrors").show();
        } else {
            $("#submissionErrors").hide();
        }

        return isValid;
    }

    function validateBenchOfficialsRow(index) {
        var rowErrors = [];
        var isEmptyRow = true;
        var license = $('input[name="BenchLicense[]"]').eq(index).val();
        var role = $('select[name="BenchRole[]"]').eq(index).val();
        var nationality = $('select[name="BenchNationality[]"]').eq(index).val();
        var gender = $('select[name="BenchGender[]"]').eq(index).val();
        var officialName = $('input[name="BenchOfficialName[]"]').eq(index).val();
        var dateOfBirth = $('input[name="BenchDateOfBirth[]"]').eq(index).val();

        // Check if all fields are empty
        if (
            (!license || license.trim() === "") &&
            (!role || role === "") &&
            (!officialName || officialName.trim() === "") &&
            (!nationality || nationality === "") &&
            (!gender || gender === "")
        ) {
            isEmptyRow = true;
        } else {
            isEmptyRow = false;

            // Validate License (can be empty)
            if (license && license.trim() !== "") {
                // Add your additional license validation logic if needed
            }

            // Validate Role
            if (!role || role === "") {
                rowErrors.push("Role must have a selected value");
            }

            // Validate Official Name
            if (!officialName || officialName.trim() === "") {
                rowErrors.push("Official Name cannot be empty");
            }

            // Validate Nationality
            if (!nationality || nationality === "") {
                rowErrors.push("Nationality must have a selected value");
            }

            // Validate Gender
            if (!gender || gender === "") {
                rowErrors.push("Gender must have a selected value");
            }
        }

        // If the row is empty, add an error message
        if (isEmptyRow) {
            rowErrors.push("Bench Official Row " + (index + 1) + " is empty.");
        }

        return rowErrors;
    }    

    function displayValidationErrors(errors) {
        var errorContainer = $('#submissionErrors');
        errorContainer.empty();

        if (errors && errors.length > 0) {
            errorContainer.show();
            var errorList = $('<ul></ul>');

            for (var i = 0; i < errors.length; i++) {
                if (errors[i]) {
                    var errorText = errors[i].name +': ' + errors[i].errors.join(', ');
                    errorList.append($('<li></li>').text(errorText));
                }
            }

            errorContainer.append(errorList);
        } else {
            errorContainer.hide();
        }
    }

    function validateForms() {
        allErrors = [];
        licenseNumbers = [];
        benchOfficialLicenseNumbers = []
        playersAndOfficials = []
        validateBenchOfficialsForm();
        validateForm();

        var licenseRoleMap = {}; // Define licenseRoleMap here
        var duplicateLicenseNumbers = {};

       @* benchOfficialLicenseNumbers.forEach(function (item) {
            var name = item.name.trim(); // Trim to handle empty or whitespace-only values
            var licenseNumber = item.license.trim(); // Trim to handle empty or whitespace-only values

            if (name !== "" && licenseNumber !== "") {
                if (!licenseRoleMap[licenseNumber]) {
                    licenseRoleMap[licenseNumber] = [];
                }

                licenseRoleMap[licenseNumber].push(item.role);

                if (licenseRoleMap[licenseNumber].length > 1) {
                    duplicateLicenseNumbers[licenseNumber] = {
                        license: licenseNumber,
                        name: name
                    };
                }
            }
        });

        licenseNumbers.forEach(function (item) {
            var name = item.name.trim(); // Trim to handle empty or whitespace-only values
            var licenseNumber = item.license.trim(); // Trim to handle empty or whitespace-only values

            if (name !== "" && licenseNumber !== "") {
                if (!licenseRoleMap[licenseNumber]) {
                    licenseRoleMap[licenseNumber] = [];
                }

                licenseRoleMap[licenseNumber].push(item.role);

                if (licenseRoleMap[licenseNumber].length > 1) {
                    duplicateLicenseNumbers[licenseNumber] = {
                        license: licenseNumber,
                        name: name
                    };
                }
            }
        });

        // Display and log errors for duplicate license numbers
        for (var licenseNumber in duplicateLicenseNumbers) {
            if (duplicateLicenseNumbers.hasOwnProperty(licenseNumber)) {
                var entry = duplicateLicenseNumbers[licenseNumber];
                var names = licenseRoleMap[licenseNumber];

                if (names && names.length > 1) {

                    allErrors.push({
                        role: "ITC Members listed as both player and bench official",
                        name: entry.license,
                        rowErrors: [entry.name]
                    });
                }
            }
        }*@

        displayValidationErrors(allErrors);
    }

    function saveAsDraft() {
        var json = generateJson();
        console.log(JSON.stringify(json));
    }

    function generateJson() {
        var formData = {
            "EventYear": @eventYear, // Assuming you have an input for EventYear
            "TitleEvent": document.getElementById('shortCode').value, // Assuming you have an input for TitleEvent
            "isChampionship": document.getElementById('isChampionship').checked, // Assuming you have a checkbox for IsChampionship
            "ItcRosterMembers": [],
            "TeamName": document.getElementById('teamName').value // Assuming you have an input for TeamName
        };

        var processRow = function (row, isBench) {
            var license = row.querySelector('[name="' + (isBench ? 'BenchLicense[]' : 'License[]') + '"]').value;
            var role = row.querySelector('[name="' + (isBench ? 'BenchRole[]' : 'Role[]') + '"]').value;
            var playerName = row.querySelector('[name="' + (isBench ? 'BenchOfficialName[]' : 'PlayerName[]') + '"]').value;
            var dateOfBirth = row.querySelector('[name="' + (isBench ? 'BenchDateOfBirth[]' : 'DateOfBirth[]') + '"]').value;
            var nationality = row.querySelector('[name="' + (isBench ? 'BenchNationality[]' : 'Nationality[]') + '"]').value;
            var gender = row.querySelector('[name="' + (isBench ? 'BenchGender[]' : 'Gender[]') + '"]').value;

            if (license || playerName) {
                formData.ItcRosterMembers.push({
                    "License": license,
                    "PlayerName": playerName,
                    "Role": role,
                    "IsBenchOfficial": isBench,
                    "DateOfBirth": dateOfBirth,
                    "Nationality": nationality,
                    "Gender": gender
                });
            }
        };

        document.querySelectorAll('#formRows tr').forEach(function (row) {
            processRow(row, false);
        });

        document.querySelectorAll('#formRowsBench tr').forEach(function (row) {
            processRow(row, true);
        });

        return formData;
    }

    $(document).ready(function () {

        var currentRow = null;

        $("#data-table tbody tr").on("click", function () {
            // Get the current row
            currentRow = $(this);

            // Extract the data from the first visible span within the cells
            var license = currentRow.find("td:eq(0) span:visible:first").text().trim();
            var role = currentRow.find("td:eq(1) span:visible:first").text().trim();
            var playerName = currentRow.find("td:eq(2) span:visible:first").text().trim();
            var jerseyNumber = currentRow.find("td:eq(3) span:visible:first").text().trim();
            var dateOfBirth = currentRow.find("td:eq(4) span:visible:first").text().trim();
            var nationality = currentRow.find("td:eq(5) span:visible:first").text().trim();
            var gender = currentRow.find("td:eq(6) span:visible:first").text().trim();

            // Populate the modal fields
            $('#edit-form #license').val(license);
            $('#edit-form #role').val(role).prop('selected', true);
            $('#edit-form #playerName').val(playerName);
            $('#edit-form #jerseyNumber').val(jerseyNumber);
            $('#edit-form #dateOfBirth').val(dateOfBirth);
            $('#edit-form #nationality').val(nationality).prop('selected', true);
            $('#edit-form #gender').val(gender).prop('selected', true);

            // Show the modal
            $('#editModal').modal('show');
        });

        $("#saveChanges").on("click", function () {
            // Retrieve values from the modal's form
            var license = $('#edit-form #license').val();
            var role = $('#edit-form #role option:selected').text();
            var playerName = $('#edit-form #playerName').val();
            var jerseyNumber = $('#edit-form #jerseyNumber').val();
            var dateOfBirth = $('#edit-form #dateOfBirth').val();
            var nationality = $('#edit-form #nationality option:selected').text();
            var gender = $('#edit-form #gender option:selected').text();

            // Update the selected row's cells with new values
            currentRow.find("td:eq(0) span span").text(license);
            currentRow.find("td:eq(1) span span").text(role);
            currentRow.find("td:eq(2) span span").text(playerName);
            currentRow.find("td:eq(3) span span").text(jerseyNumber);
            currentRow.find("td:eq(4) span span").text(dateOfBirth);
            currentRow.find("td:eq(5) span span").text(nationality);
            currentRow.find("td:eq(6) span span").text(gender);

            // Hide the modal
            $('#editModal').modal('hide');
        });


        // Handle the save button click
        $(".close-edit").on("click", function () {
            // TODO: Add code to handle the form data, e.g., send an AJAX request
            $('#editModal').modal('hide');
        });

        // When the user clicks anywhere outside of the modal, close it
        $(window).on("click", function (event) {
            var modal = $("#edit-modal");
            if ($(event.target).is(modal)) {
                modal.hide();
            }
        });

        // Handle the form submission
        $("#edit-form").on("submit", function (event) {
            event.preventDefault();
            // TODO: Add code to handle the form data, e.g., send an AJAX request

            $("#edit-modal").hide();
        });

        // Validate existing rows on page load
        validateAllLicenses();
        validateAllJerseyNumbers();
        validateRoles();

        // Attach event handlers for input changes
        $('input[name^="License"]').on('input', function () {
            validateAllLicenses();
        });

        $('input[name^="JerseyNumber"]').on('input', function () {
            validateAllJerseyNumbers();
        });

        $(document).on('change', 'select[name^="Role"]', function () {
            validateRoles();
        });

        // Attach event handlers for losing focus
        $('input[name^="License"]').on('blur', function () {
            validateAllLicenses();
        });

        $('input[name^="JerseyNumber"]').on('blur', function () {
            validateAllJerseyNumbers();
        });

        var nationalityDropdown = $('select[name^="Nationality"]');
        for (var i = 0; i < countries.length; i++) {
            var option = $('<option></option>').attr('value', countries[i]).text(countries[i]);
            nationalityDropdown.append(option);
        }

        $("#addBenchOfficialButtonErrors").hide()

        $('#eventSelect').on('change', function () {
            var selectedValue = $(this).val();
            $.get('/umbraco/surface/events/GetEventInformation', { id: selectedValue }, function (data) {
                $('#eventInformation').html(data);
            });
        });

    });

    // Create the Pickr instance
    const pickr = Pickr.create({
        el: '#colorPicker',
        theme: 'classic', // or 'monolith', or 'nano'

        swatches: [
            'rgba(244, 67, 54, 1)',
            'rgba(233, 30, 99, 0.95)',
            // ... more colors
        ],

        components: {
            // Main components
            preview: true,
            opacity: true,
            hue: true,

            // Input / output Options
            interaction: {
                hex: true,
                rgba: true,
                hsla: false,
                hsva: false,
                cmyk: false,
                input: true,
                clear: true,
                save: true
            }
        }
    });

    const pickr2 = Pickr.create({
        el: '#colorPicker2',
        theme: 'classic', // or 'monolith', or 'nano'

        swatches: [
            'rgba(244, 67, 54, 1)',
            'rgba(233, 30, 99, 0.95)',
            // ... more colors
        ],

        components: {
            // Main components
            preview: true,
            opacity: false,
            hue: true,

            // Input / output Options
            interaction: {
                hex: true,
                rgba: true,
                hsla: false,
                hsva: false,
                cmyk: false,
                input: true,
                clear: true,
                save: true
            }
        },
        strings: {
            save: 'Apply', // Change the text for the save button to 'Apply'
            // ... other string customizations ...
        }
    });

    // Add event listener for color change
    pickr.on('change', (color, instance) => {
        console.log('Selected color:', color.toRGBA().toString());
        // Perform your action with the color value
    });

</script>
