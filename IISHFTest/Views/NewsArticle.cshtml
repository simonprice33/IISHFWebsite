@using Umbraco.Cms.Web.Common.PublishedModels;
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<ContentModels.NewsArticle>
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using Umbraco.Cms.Core.PropertyEditors.ValueConverters
@using System.Globalization
@using Newtonsoft.Json.Linq
@{
    Layout = "Main.cshtml";

    var imageCropper = Model.Value<ImageCropperValue>("articleImage");
    var thumbCrop = imageCropper.Crops.FirstOrDefault(x => x.Alias == "Narrow");
    var thumbUrl = string.Empty;
    if (thumbCrop != null)
    {
        var b = true;
        var width = thumbCrop.Width.ToString();
        var height = thumbCrop.Height.ToString();
        thumbUrl = $"{imageCropper.Src}?mode=crop&width={width}&height={height}";
    }

    var articleUrl = Model.Url(null, UrlMode.Absolute);

    var relatedArticles = Model.Value<System.Collections.Generic.IList<IPublishedContent>>("ArticleRelatedContent");

}

@section head
{
    <meta property="og:title" content="@Model.Name"/>
    <meta property="og:description" content="@Model.LeadIn"/>
    <meta property="og:type" content="News Article"/>
}


<div class="jumbotron jumbotron-fluid hero hero-large" style="background-image: url('@thumbUrl')">
    <div class="overlay"></div>
    <div class="inner">
        <div class="container custom-container">
            <h1 class="display-4">@Model.Value("heroTitle")</h1>
            <p class="lead">@Model.Value("heroSubtitle")</p>
        </div>
    </div>
</div>
<div class="container">
    <div class="row mb-5">
        <div class="col-12 col-sm-12 col-md-9 col-lg-9">
            <h1 class="orange text-center">@Model.ArticleTitle</h1>

            @Model.ArticleContent
            <br />
            Tags: @string.Join(",", @Model.NewsCategories)
            <br />
            <br />
            Authored By: @Model.Author<br />
            @Model.PostDate.ToString("dd.MM.yyyy")
            <br />
        </div>
        <div class="col-12 col-sm-12 col-md-3 col-lg-3">
            
            @{
                if (relatedArticles != null && relatedArticles.Any())
                {

                    <h2 class="orange text-center">Related Stores</h2>
                    var limitedItems = relatedArticles
                    .Where(x => x.IsVisible() && x.Value<DateTime>("postDate") <= DateTime.UtcNow)
                    .OrderByDescending(x => x.Value<DateTime>("postDate")).Take(3);
                    @foreach (var article in limitedItems)
                    {
                        var imageCropperJson = article.Value<string>("articleImage");
                        var imageCropperObj = JObject.Parse(imageCropperJson);
                        var originalImageUrl = imageCropperObj["src"].ToString();

                        var thumbCropRelated = imageCropperObj["crops"]?.FirstOrDefault(c => c["alias"].ToString() == "Thumb");
                        var thumbUrlRelated = string.Empty;
                        if (thumbCropRelated != null)
                        {
                            var width = thumbCropRelated["width"].ToString();
                            var height = thumbCropRelated["height"].ToString();
                            thumbUrlRelated = $"{originalImageUrl}?mode=crop&width={width}&height={height}";
                        }

                        <div class="col-12 col-sm-12 col-lg-12 mb-5">
                            <a href="@article.Url()" class="card-link">
                                <div class="card">
                                    <img class="card-img-top" src="@thumbUrlRelated" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">@article.Name</h5>
                                        <p class="card-text">@article.Value("leadIn")</p>
                                    </div>
                                    <div class="card-overlay">
                                        <i class="fa-regular fa-eye fa-flip-vertical text-white mr-3"></i>
                                        <span class="overlay-text">Read Now</span>
                                    </div>

                                </div>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <h2 class="orange text-center">Other News</h2>

                    var newsArticles = Umbraco.Content(Guid.Parse("6627a7e1-7f4d-467e-a29e-cc71a885a27f"))
                    .ChildrenOfType("newsArticle")
                    .Where(x => x.IsVisible() && x.Id != Model.Id && x.Value<DateTime>("postDate") <= DateTime.UtcNow)
                    .OrderByDescending(x => x.Value<DateTime>("postDate"));

                    @foreach (var article in newsArticles)
                    {
                        var imageCropperJson = article.Value<string>("articleImage");
                        var imageCropperObj = JObject.Parse(imageCropperJson);
                        var originalImageUrl = imageCropperObj["src"].ToString();

                        var thumbCropRelated = imageCropperObj["crops"]?.FirstOrDefault(c => c["alias"].ToString() == "Thumb");
                        var thumbUrlRelated = string.Empty;
                        if (thumbCropRelated != null)
                        {
                            var width = thumbCropRelated["width"].ToString();
                            var height = thumbCropRelated["height"].ToString();
                            thumbUrlRelated = $"{originalImageUrl}?mode=crop&width={width}&height={height}";
                        }

                        <div class="col-12 col-sm-12 col-lg-12 mb-5">
                            <a href="@article.Url()" class="card-link">
                                <div class="card">
                                    <img class="card-img-top" src="@thumbUrlRelated" alt="Card image cap">
                                    <div class="card-body">
                                        <h5 class="card-title">@article.Name</h5>
                                        <p class="card-text">@article.Value("leadIn")</p>
                                    </div>
                                    <div class="card-overlay">
                                        <i class="fa-regular fa-eye fa-flip-vertical text-white mr-3"></i>
                                        <span class="overlay-text">Read Now</span>
                                    </div>

                                </div>
                            </a>
                        </div>
                    }

                }
            }
        </div>
        <div class="col-12 col-sm-12 col-md-12 col-lg-12">
            <footer class="fa-border d-flex justify-content-center align-items-center mt-5 mb-5">
                <div class="d-flex">
                    <a class="ml-2 mr-2 orange" href="https://www.twitter.com/intent/tweet?text=@Model.Name&amp;url=@articleUrl"><i class="fab fa-twitter fa-2x"></i></a>
                    <a class="ml-2 mr-2 orange" href="https://www.facebook.com/sharer/sharer.php?u=@articleUrl"><i class="fab fa-facebook fa-2x"></i></a>
                </div>
            </footer>

        </div>

    </div>

</div>
