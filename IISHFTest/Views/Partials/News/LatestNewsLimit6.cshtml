@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels;
@using Newtonsoft.Json.Linq

<section class="home-news-section">
<h1 class="text-center mb-4"><span class="orange">Latest</span> news</h1>

    @{
        var newsArticles = Umbraco.Content(Guid.Parse("6627a7e1-7f4d-467e-a29e-cc71a885a27f"))
        .ChildrenOfType("newsArticle")
        .Where(x => x.IsVisible() && x.Value<DateTime>("postDate") <= DateTime.UtcNow)
        .OrderByDescending(x => x.Value<DateTime>("postDate"))
        .Take(6);
    }

    <div class="container ">
        <div class="row">
            @foreach (var article in newsArticles)
            {
                var imageCropperJson = article.Value<string>("articleImage");
                var imageCropperObj = JObject.Parse(imageCropperJson);
                var originalImageUrl = imageCropperObj["src"].ToString();

                var thumbCrop = imageCropperObj["crops"]?.FirstOrDefault(c => c["alias"].ToString() == "Main");
                var thumbUrl = string.Empty;
                if (thumbCrop != null)
                {
                    var width = int.Parse(thumbCrop["width"].ToString());
                    var height = int.Parse(thumbCrop["height"].ToString());

                    var coordinates = thumbCrop["coordinates"];
                    if (coordinates is JObject && coordinates["x1"] is JToken x1Token &&
                    coordinates["y1"] is JToken y1Token && coordinates["x2"] is JToken x2Token &&
                    coordinates["y2"] is JToken y2Token)
                    {
                        double x1, y1, x2, y2;
                        if (double.TryParse(x1Token.ToString(), out x1) &&
                        double.TryParse(y1Token.ToString(), out y1) &&
                        double.TryParse(x2Token.ToString(), out x2) &&
                        double.TryParse(y2Token.ToString(), out y2))
                        {
                            // Convert fractional coordinates to pixel values
                            var cropX = (int)(x1 * width);
                            var cropY = (int)(y1 * height);
                            var cropWidth = (int)((x2 - x1) * width);
                            var cropHeight = (int)((y2 - y1) * height);

                            thumbUrl = $"{originalImageUrl}?mode=crop&x={cropX}&y={cropY}&width={cropWidth}&height={cropHeight}";
                        }
                        else
                        {
                            // Handle the case where coordinates are not valid numbers
                            // Possibly log this issue and decide on fallback behavior
                            thumbUrl = originalImageUrl; // Fallback to the original image
                        }
                    }
                    else
                    {
                        thumbUrl = $"{originalImageUrl}?mode=crop&width={width}&height={height}";
                    }
                }

                <div class="col-6 col-sm-6 col-md-4 col-lg-4 mb-2">
                    <a href="@article.Url()" class="card-link">
                        <div class="card">
                            <img class="card-img-top" src="@thumbUrl" alt="Card image cap">
                            <div class="card-body news">
                                <h5 class="card-title">@article.Name</h5>
                                <p class="card-text">@article.Value("leadIn")</p>
                            </div>
                            <div class="card-overlay">
                                <i class="fa-regular fa-eye fa-flip-vertical text-white mr-3"></i>
                                <span class="overlay-text">Read Now</span>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>

</section>